# Lab 8: System Integration with Buildroot

## DON'T PANIC

The Hitchhiker's Guide to Embedded Linux has this to say about root filesystems:

*"A root filesystem is where all your files live. Think of it as the contents of your towel bag - essential utilities, helpful tools, and the occasional item whose purpose you've completely forgotten but you're certain you'll need eventually."*

## Objectives

Master automated embedded Linux system building with Buildroot:

- Understand Buildroot architecture and workflow
- Configure Buildroot for BeaglePlay (ARM64 Cortex-A53)
- Integrate custom external toolchain
- Build kernel with custom patches and configuration
- Select and configure packages (BusyBox, alsa-utils, mpd)
- Create custom Buildroot packages for out-of-tree drivers
- Use root filesystem overlays for customization
- Generate reproducible system images
- Analyze package dependencies

## Prerequisites

- Completed Lab 7 (Block Filesystems)
- Custom toolchain from Lab 1
- Kernel configuration from Lab 4
- Nunchuk driver from Lab 6
- Understanding of embedded Linux components

## Lab Duration

Approximately 4-5 hours

## Buildroot Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                     Buildroot Workflow                          │
└─────────────────────────────────────────────────────────────────┘

Input Configuration:
  - .config (generated by make menuconfig)
  - board/<vendor>/<board>/
      ├── linux.config (kernel config)
      ├── *.patch (kernel patches)
      └── rootfs-overlay/ (filesystem customization)

              ↓ make

Download Phase:
  - Fetch packages from upstream (dl/ directory)
  - Verify checksums
  
              ↓

Build Phase (output/build/):
  - Extract packages
  - Apply patches
  - Configure (./configure, cmake, meson)
  - Compile (make, ninja)
  - Install to staging/ (headers, libraries)
  - Install to target/ (binaries, stripped)

              ↓

Image Generation (output/images/):
  - rootfs.tar (tarball)
  - Image.gz (kernel)
  - *.dtb (device trees)
  - Optional: SD card images, initramfs

              ↓

Deployment:
  - Extract to NFS root
  - Write to SD card
  - TFTP boot
```

## Environment Setup

### Working Directory

```bash
cd $HOME/embedded-linux-beagleplay-labs
mkdir -p buildroot-lab
cd buildroot-lab
```

### Clone Buildroot

```bash
# Clone official Buildroot repository
git clone https://git.buildroot.net/buildroot
cd buildroot

# Checkout stable LTS release
git checkout 2024.02.x

# Note: Use LTS releases for production systems
```

## Section 1: Board-Specific Files

### Create Board Directory Structure

```bash
cd $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot

# Create board-specific directory
mkdir -p board/beagleplay/training
```

### Copy Kernel Configuration

```bash
# Copy the kernel config from Lab 4
cp $HOME/embedded-linux-beagleplay-labs/kernel/linux/.config \
   board/beagleplay/training/linux.config

# Verify it's a valid ARM64 config
grep "CONFIG_ARM64=y" board/beagleplay/training/linux.config
```

### Copy Kernel Patches

We'll include our custom Device Tree from Lab 6.

```bash
# Copy the Device Tree patch
cp $HOME/embedded-linux-beagleplay-labs/kernel/linux/0001-Custom-DTS-for-Bootlin-lab.patch \
   board/beagleplay/training/

# Note: If you didn't create this patch in Lab 6, create it now:
cd $HOME/embedded-linux-beagleplay-labs/kernel/linux

# Ensure you're on your custom branch
git checkout beagleplay-labs

# Create patch from the custom DTS commit
git format-patch -1 HEAD -o $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot/board/beagleplay/training/
```

### Prepare Root Filesystem Overlay

```bash
cd $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot

# Create overlay directory
mkdir -p board/beagleplay/training/rootfs-overlay

# We'll populate this later with custom scripts
```

**Verification Checklist:**

- [ ] Buildroot cloned and checked out to LTS version
- [ ] `board/beagleplay/training/` directory created
- [ ] Kernel configuration copied
- [ ] Kernel patch file present
- [ ] Root filesystem overlay directory created

## Section 2: Buildroot Configuration

### Start Configuration

```bash
cd $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot

# Launch menuconfig
make menuconfig
```

### Target Architecture

```
Target options --->
    Target Architecture (AArch64 (little endian))
    Target Architecture Variant (cortex-A53)
    Floating point strategy (FP-ARMv8)
```

### Toolchain Configuration

We'll use our custom toolchain from Lab 1.

```
Toolchain --->
    Toolchain type (External toolchain)
    *** Toolchain External Options ***
    Toolchain (Custom toolchain)
    Toolchain origin (Pre-installed toolchain)
    Toolchain path (/home/<user>/x-tools/aarch64-beagleplay-linux-musl)
        # Replace <user> with your username
    
    Toolchain prefix (aarch64-beagleplay-linux-musl)
    
    External toolchain gcc version (14.x)
    External toolchain kernel headers series (6.6.x or later)
    External toolchain C library (musl)
    
    [*] Toolchain has SSP support?
    [*] Toolchain has C++ support?
```

**Important (like knowing where your towel is):** Adjust paths to match your actual toolchain location.

### Kernel Configuration

```
Kernel --->
    [*] Linux Kernel
    
    Kernel version --->
        (X) Custom version
        (6.6.52) Kernel version
            # Use the version from your Lab 4 kernel
    
    Custom kernel patches --->
        board/beagleplay/training/0001-Custom-DTS-for-Bootlin-lab.patch
    
    Kernel configuration --->
        (X) Using a custom (def)config file
        (board/beagleplay/training/linux.config) Configuration file path
    
    Kernel binary format --->
        (X) Image.gz
    
    [*] Build a Device Tree Blob (DTB)
        (ti/k3-am625-beagleplay-custom) In-tree Device Tree Source file names
            # Without .dts extension, relative to arch/arm64/boot/dts/
```

### Target Packages - Core System

```
Target packages --->
    BusyBox --->
        [*] (default) # Keep BusyBox enabled with default config
    
    Audio and video applications --->
        [*] alsa-utils
            alsa-utils selection --->
                [*] speaker-test
                [ ] Disable all other options
        
        [*] mpd
            *** MPD configuration ***
            Audio support --->
                [*] alsa
            Input format support --->
                [*] vorbis
            Network protocols support --->
                [*] tcp sockets
        
        [*] mpc (MPD client)
    
    Hardware handling --->
        [*] evtest
```

### Filesystem Images

```
Filesystem images --->
    [*] tar the root filesystem
        Compression method (no compression)
```

### System Configuration

```
System configuration --->
    Root filesystem overlay directories --->
        board/beagleplay/training/rootfs-overlay
    
    Root password (leave empty for no password)
    
    /dev management (Dynamic using devtmpfs only)
    
    [*] Enable root login with password
    [ ] Run a getty (login prompt) after boot
        # We'll use serial console directly
```

### Save Configuration

Press `Exit` repeatedly until asked to save, then select `Yes`.

**Verification Checklist:**

- [ ] Target architecture set to ARM64 Cortex-A53
- [ ] External toolchain configured with correct path
- [ ] Kernel version and configuration specified
- [ ] Custom DTS patch included
- [ ] Required packages selected (alsa-utils, mpd, mpc, evtest)
- [ ] Root filesystem overlay path set
- [ ] Configuration saved to `.config`

## Section 3: Root Filesystem Overlay

### Create Module Loading Script

Buildroot uses a different init system than our manual setup, so we'll automate module loading.

```bash
cd $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot/board/beagleplay/training/rootfs-overlay

# Create init.d directory
mkdir -p etc/init.d

# Create module loading script
cat > etc/init.d/S03modprobe << 'EOF'
#!/bin/sh

case "$1" in
    start)
        echo "Loading kernel modules..."
        modprobe snd-usb-audio
        ;;
    stop)
        ;;
    restart|reload)
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
esac

exit 0
EOF

# Make executable
chmod +x etc/init.d/S03modprobe
```

### Add MPD Configuration

```bash
# Download music files for testing (if not already present)
cd $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot/board/beagleplay/training/rootfs-overlay

# Create MPD music directory
mkdir -p var/lib/mpd/music

# Copy music files from previous labs (or download samples)
# For this lab, we'll create placeholder structure
# In production, you'd include actual audio files

# Create MPD configuration
mkdir -p etc
cat > etc/mpd.conf << 'EOF'
music_directory     "/var/lib/mpd/music"
playlist_directory  "/var/lib/mpd/playlists"
db_file             "/var/lib/mpd/database"
log_file            "/var/log/mpd.log"
pid_file            "/var/run/mpd.pid"
state_file          "/var/lib/mpd/state"
sticker_file        "/var/lib/mpd/sticker.sql"

bind_to_address     "any"
port                "6600"

audio_output {
    type            "alsa"
    name            "USB Audio Device"
    mixer_type      "software"
}
EOF
```

**Verification Checklist:**

- [ ] Module loading script created and executable
- [ ] MPD configuration file created
- [ ] Overlay directory structure prepared

## Section 4: Build the System

### Start the Build

```bash
cd $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot

# Start build (this will take 20-60 minutes)
make -j$(nproc)
```

**Expected Progress:**

```
>>> host-pkgconf 2.0.3 Downloading
>>> host-pkgconf 2.0.3 Extracting
>>> host-pkgconf 2.0.3 Configuring
>>> host-pkgconf 2.0.3 Building
>>> host-pkgconf 2.0.3 Installing to host directory
>>> linux 6.6.52 Downloading
>>> linux 6.6.52 Extracting
>>> linux 6.6.52 Patching
>>> linux 6.6.52 Configuring
>>> linux 6.6.52 Building
>>> linux 6.6.52 Installing to images directory
>>> busybox 1.36.1 Downloading
...
>>> Generating filesystem image rootfs.tar
>>> Generating root filesystem image rootfs.tar
```

### Explore Build Output

```bash
cd $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot

# Build directory (extracted and compiled packages)
ls output/build/
# Shows: busybox-1.36.1/ linux-6.6.52/ mpd-0.23.14/ ...

# Host tools (tools used during build)
ls output/host/
# Shows: bin/ sbin/ lib/ share/ usr/ ...

# Staging directory (headers, libraries for compilation)
ls output/staging/
# Shows: usr/include/ usr/lib/ ...

# Target root filesystem (before packaging)
ls output/target/
# Shows: bin/ etc/ lib/ sbin/ usr/ var/ ...

# Final images
ls output/images/
# Shows: Image.gz  k3-am625-beagleplay-custom.dtb  rootfs.tar
```

**Understanding Output Directories:**

| Directory | Purpose | Size | Usage |
|-----------|---------|------|-------|
| `output/build/` | Source and build trees | Large (GB) | Package compilation |
| `output/host/` | Host tools | Medium (MB) | Build tools (pkgconf, genext2fs) |
| `output/staging/` | Development files | Medium | Headers, libraries for linking |
| `output/target/` | Target filesystem | Small (MB) | Actual root filesystem content |
| `output/images/` | Final images | Small | Deployable artifacts |

**Verification Checklist:**

- [ ] Build completed without errors
- [ ] `output/images/Image.gz` exists (kernel)
- [ ] `output/images/k3-am625-beagleplay-custom.dtb` exists
- [ ] `output/images/rootfs.tar` exists (root filesystem)
- [ ] Module loading script present in `output/target/etc/init.d/`

## Section 5: Deploy and Test

### Create NFS Root Directory

```bash
cd $HOME/embedded-linux-beagleplay-labs/buildroot-lab
mkdir -p nfsroot

# Extract root filesystem
cd nfsroot
tar xvf ../buildroot/output/images/rootfs.tar
```

### Update NFS Exports

```bash
# Edit /etc/exports
sudo vi /etc/exports

# Add line:
# /home/<user>/embedded-linux-beagleplay-labs/buildroot-lab/nfsroot *(rw,no_root_squash,no_subtree_check)

# Reload NFS exports
sudo exportfs -ra
```

### Update Kernel and DTB

```bash
# Copy to TFTP directory
cp $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot/output/images/Image.gz \
   /srv/tftp/

cp $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot/output/images/k3-am625-beagleplay-custom.dtb \
   /srv/tftp/
```

### Boot BeaglePlay

**Update U-Boot to use Buildroot NFS root:**

```bash
# On U-Boot console
=> setenv nfsroot /home/<user>/embedded-linux-beagleplay-labs/buildroot-lab/nfsroot
=> setenv bootargs console=ttyS2,115200 root=/dev/nfs ip=192.168.0.100:::::eth0 nfsroot=${serverip}:${nfsroot},nfsvers=3,tcp rw
=> saveenv
=> boot
```

### Verify System Boot

```bash
# On BeaglePlay, after boot

# Check kernel version
uname -a

# Check loaded modules
lsmod | grep snd
# Should show snd_usb_audio if USB device is plugged in

# Check BusyBox version
busybox --help

# Verify package presence
which speaker-test
which evtest
which mpd
which mpc
```

**Verification Checklist:**

- [ ] NFS root created from Buildroot tarball
- [ ] NFS exports updated and reloaded
- [ ] Kernel and DTB copied to TFTP
- [ ] BeaglePlay boots from Buildroot root filesystem
- [ ] USB audio module loads automatically
- [ ] BusyBox and selected packages present

## Section 6: Test Audio with MPD

### Prepare Music Files

First, add actual music files to the overlay (for future builds) or directly to the NFS root:

```bash
# On workstation
cd $HOME/embedded-linux-beagleplay-labs/buildroot-lab/nfsroot/var/lib/mpd/music

# Copy OGG/MP3 files (sample music)
# For testing, you can use free music from:
# https://freemusicarchive.org/ or
# https://incompetech.com/

# Example (if you have sample.ogg):
cp ~/Downloads/sample.ogg .
```

### Start MPD and Test Playback

```bash
# On BeaglePlay

# Check if MPD is running
ps | grep mpd

# If not running, start it
/etc/init.d/S95mpd start

# Update MPD database
mpc update

# Wait a few seconds, then check indexed files
mpc listall

# Expected output:
# sample.ogg
# ...

# Add all files to playlist
mpc add /

# Start playback
mpc play

# Control playback
mpc pause
mpc next
mpc volume +10
mpc volume -5
```

### Check MPD Logs

```bash
# View MPD log
cat /var/log/mpd.log

# Should show:
# Jan  1 00:00 : update: added /sample.ogg
# Jan  1 00:01 : player: played "sample.ogg"
```

**Verification Checklist:**

- [ ] MPD service running
- [ ] Music files indexed by MPD
- [ ] Playback functional with `mpc play`
- [ ] Volume and navigation controls work

## Section 7: Adding Custom Package - Nunchuk Driver

Now we'll create a Buildroot package for our Nunchuk driver.

### Create Package Directory

```bash
cd $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot

mkdir -p package/nunchuk-driver
```

### Create Config.in

```bash
cat > package/nunchuk-driver/Config.in << 'EOF'
config BR2_PACKAGE_NUNCHUK_DRIVER
    bool "nunchuk-driver"
    depends on BR2_LINUX_KERNEL
    help
      Linux kernel module for the I2C Nintendo Wii Nunchuk.
      
      Provides input device interface for Nunchuk joystick
      and buttons when connected via I2C bus.
      
      https://github.com/bootlin/training-materials
EOF
```

### Create Package Makefile

```bash
cat > package/nunchuk-driver/nunchuk-driver.mk << 'EOF'
################################################################################
#
# nunchuk-driver
#
################################################################################

NUNCHUK_DRIVER_VERSION = 1.0
NUNCHUK_DRIVER_SITE = $(HOME)/embedded-linux-beagleplay-labs/hardware/nunchuk-driver
NUNCHUK_DRIVER_SITE_METHOD = local
NUNCHUK_DRIVER_LICENSE = GPL-2.0

$(eval $(kernel-module))
$(eval $(generic-package))
EOF
```

**The Guide notes:** Adjust `NUNCHUK_DRIVER_SITE` to point to your actual driver location.

### Integrate into Buildroot Menu

```bash
# Edit package/Config.in
vi package/Config.in

# Find the "Hardware handling" menu section
# Add before "menu "Hardware handling"":

# Around line 1200-1300 (search for "menu "Hardware handling"")
# Add this line just before the nvidia-driver line:
#     source "package/nunchuk-driver/Config.in"
```

**Using editor:**

Find this section:
```
menu "Hardware handling"
    source "package/acsccid/Config.in"
    ...
    source "package/nvidia-driver/Config.in"  # Add BEFORE this line
```

Add:
```
    source "package/nunchuk-driver/Config.in"
```

### Enable Nunchuk Package

```bash
# Reconfigure Buildroot
make menuconfig

# Navigate to:
# Target packages --->
#     Hardware handling --->
#         [*] nunchuk-driver

# Save and exit
```

### Copy Driver Source

Ensure the driver source is accessible:

```bash
# Verify driver exists
ls $HOME/embedded-linux-beagleplay-labs/hardware/nunchuk-driver/

# Should show: nunchuk.c  Makefile
```

### Rebuild with Nunchuk Module

```bash
cd $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot

# Rebuild (incremental - much faster)
make
```

### Update NFS Root

```bash
cd $HOME/embedded-linux-beagleplay-labs/buildroot-lab/nfsroot

# Remove old content
rm -rf *

# Extract new rootfs
tar xvf ../buildroot/output/images/rootfs.tar
```

### Auto-Load Nunchuk Module

Update the module loading script:

```bash
# Edit overlay
cd $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot/board/beagleplay/training/rootfs-overlay

vi etc/init.d/S03modprobe

# Modify to add nunchuk:
```

```bash
#!/bin/sh

case "$1" in
    start)
        echo "Loading kernel modules..."
        modprobe snd-usb-audio
        modprobe nunchuk
        ;;
    stop)
        ;;
    restart|reload)
        ;;
    *)
        echo "Usage: $0 {start|stop|restart}"
        exit 1
esac

exit 0
```

### Rebuild and Test

```bash
# Rebuild Buildroot
cd $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot
make

# Update NFS root
cd ../nfsroot
rm -rf *
tar xvf ../buildroot/output/images/rootfs.tar

# Reboot BeaglePlay
```

### Verify Nunchuk Driver

```bash
# On BeaglePlay, after boot

# Check if nunchuk module is loaded
lsmod | grep nunchuk

# Check I2C device binding
ls -l /sys/bus/i2c/drivers/nunchuk/
# Should show: 3-0052 -> ../../../../devices/.../i2c-3/3-0052

# Test with evtest
evtest

# Select Nunchuk device, press buttons to see events
```

**Verification Checklist:**

- [ ] Nunchuk package created in `package/nunchuk-driver/`
- [ ] Package integrated into Buildroot menu
- [ ] Package enabled in configuration
- [ ] Build includes nunchuk module
- [ ] Module loads automatically at boot
- [ ] Nunchuk input device functional

## Section 8: Dependency Analysis

Buildroot provides tools to visualize package dependencies.

### Install Graphviz

```bash
# On workstation
sudo apt install graphviz
```

### Generate Dependency Graph

```bash
cd $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot

# Generate graph
make graph-depends

# View PDF
evince output/graphs/graph-depends.pdf
```

### Analyze Dependencies

The graph shows why certain packages were built. Key observations:

- **MPD** requires:
  - `meson` (host tool)
  - `python3` (host tool for meson)
  - `alsa-lib`
  - `libvorbis` (for OGG support)
  
- **alsa-utils** requires:
  - `alsa-lib`
  - `ncurses` (for interactive tools)

- **Nunchuk driver** requires:
  - Linux kernel

### Package Size Analysis

```bash
# Generate package size statistics
make graph-size

# View results
evince output/graphs/graph-size.pdf
```

This shows which packages consume the most storage.

**Verification Checklist:**

- [ ] Dependency graph generated successfully
- [ ] Visualized with `evince` or PDF viewer
- [ ] Understood major dependency chains

## Section 9: Buildroot Best Practices

### External Tree (Out-of-Tree Configuration)

For production, use an external tree to keep customizations separate:

```bash
# Create external tree
mkdir -p $HOME/embedded-linux-beagleplay-labs/buildroot-external/beagleplay

cd $HOME/embedded-linux-beagleplay-labs/buildroot-external/beagleplay

# Create external.desc
cat > external.desc << 'EOF'
name: BEAGLEPLAY
desc: BeaglePlay custom external tree
EOF

# Create external.mk
touch external.mk

# Create Config.in
cat > Config.in << 'EOF'
source "$BR2_EXTERNAL_BEAGLEPLAY_PATH/package/nunchuk-driver/Config.in"
EOF

# Move board files
mv $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot/board/beagleplay \
   board/

# Move package
mkdir -p package
mv $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot/package/nunchuk-driver \
   package/
```

**Use external tree:**

```bash
cd $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot

# Configure with external tree
make BR2_EXTERNAL=$HOME/embedded-linux-beagleplay-labs/buildroot-external/beagleplay menuconfig
```

### Configuration Fragments

For kernel and BusyBox, use configuration fragments instead of full configs:

```bash
# Kernel fragment example
cat > board/beagleplay/training/linux-fragment.config << 'EOF'
CONFIG_GPIO_SYSFS=y
CONFIG_LEDS_CLASS=y
CONFIG_LEDS_GPIO=y
CONFIG_SND_USB_AUDIO=m
EOF
```

Reference in Buildroot menuconfig:
```
Kernel --->
    Additional fragments for the kernel configuration
        (board/beagleplay/training/linux-fragment.config)
```

### Defconfig Files

Save your configuration as a defconfig:

```bash
cd $HOME/embedded-linux-beagleplay-labs/buildroot-lab/buildroot

# Save defconfig
make savedefconfig BR2_DEFCONFIG=configs/beagleplay_defconfig

# Later, restore with:
# make beagleplay_defconfig
```

## Troubleshooting Guide

### Problem: External toolchain not found

**Error:**

```
Incorrect selection of the C library
```

**Solution:**

1. Verify toolchain path:

```bash
ls /home/<user>/x-tools/aarch64-beagleplay-linux-musl/bin/
# Should show: aarch64-beagleplay-linux-musl-gcc ...
```

2. Check toolchain configuration in menuconfig:
   - Toolchain path matches actual location
   - Toolchain prefix is correct
   - GCC version matches

3. Test toolchain manually:

```bash
/home/<user>/x-tools/aarch64-beagleplay-linux-musl/bin/aarch64-beagleplay-linux-musl-gcc --version
```

### Problem: Kernel build fails

**Error:**

```
>>> linux 6.6.52 Building
ERROR: ...
```

**Solutions:**

1. **Missing dependencies:**

```bash
sudo apt install bc bison flex libssl-dev libncurses-dev
```

2. **Kernel config mismatch:**

Verify `board/beagleplay/training/linux.config` is a valid ARM64 config:

```bash
grep "CONFIG_ARM64=y" board/beagleplay/training/linux.config
```

3. **Patch application failed:**

Check if custom DTS patch applies cleanly:

```bash
cd output/build/linux-6.6.52
patch -p1 --dry-run < ../../../board/beagleplay/training/0001-Custom-DTS-for-Bootlin-lab.patch
```

### Problem: Package not found in menu

**Symptom:** Nunchuk driver doesn't appear in `Hardware handling` menu.

**Solution:**

1. Verify `package/nunchuk-driver/Config.in` exists

2. Check `package/Config.in` includes the line:

```bash
grep "nunchuk-driver" package/Config.in
```

Should show:
```
    source "package/nunchuk-driver/Config.in"
```

3. Regenerate menuconfig cache:

```bash
make menuconfig
# Exit and re-enter
```

### Problem: Module version mismatch

**Error:**

```
insmod: ERROR: could not insert module nunchuk.ko: Invalid module format
```

**Cause:** Module compiled against different kernel version.

**Solution:**

Rebuild both kernel and modules:

```bash
make linux-dirclean
make nunchuk-driver-dirclean
make
```

### Problem: NFS root is outdated

**Symptom:** Changes don't appear after rebuild.

**Solution:**

Always re-extract rootfs.tar:

```bash
cd $HOME/embedded-linux-beagleplay-labs/buildroot-lab/nfsroot
rm -rf *
tar xvf ../buildroot/output/images/rootfs.tar
```

## Advanced Challenges

### Challenge 1: Create Buildroot Defconfig

Save your complete configuration as a reusable defconfig for BeaglePlay.

**Steps:**
1. `make savedefconfig BR2_DEFCONFIG=configs/beagleplay_training_defconfig`
2. Test restoration: `make clean && make beagleplay_training_defconfig && make`

### Challenge 2: Add Custom Init System

Replace BusyBox init with systemd or OpenRC.

**Hint:** 
```
System configuration --->
    Init system (systemd)
```

Note: systemd requires glibc, not musl!

### Challenge 3: Generate SD Card Image

Configure Buildroot to create a complete SD card image with all partitions.

**Hint:**
```
Filesystem images --->
    [*] ext4 root filesystem
    [ ] tar the root filesystem  # Disable
    [*] genimage
```

Create `genimage.cfg` for partition layout.

### Challenge 4: Cross-Compile Application

Create a custom Buildroot package for the Nunchuk MPD client from Lab 9.

**Structure:**
- `package/nunchuk-mpd-client/Config.in`
- `package/nunchuk-mpd-client/nunchuk-mpd-client.mk`
- Use `NUNCHUK_MPD_CLIENT_DEPENDENCIES = libmpdclient`

### Challenge 5: Multi-Config Build

Set up configurations for:
- Development (NFS root, debug symbols, strace, gdb)
- Production (SquashFS, stripped, minimal)

## What You've Learned

By completing this lab, you've mastered:

✅ **Buildroot Architecture:**
- Understood Buildroot workflow (download → build → install → image)
- Navigated output directories (build, host, staging, target, images)
- Understood difference between target and staging

✅ **Configuration Management:**
- Used `make menuconfig` to configure system
- Integrated external toolchain
- Configured kernel with custom config and patches
- Selected target packages

✅ **Package Management:**
- Enabled built-in packages (BusyBox, alsa-utils, mpd)
- Created custom package for out-of-tree kernel module
- Integrated package into Buildroot menu system
- Used `$(kernel-module)` and `$(generic-package)` infrastructures

✅ **Root Filesystem Customization:**
- Created root filesystem overlay
- Added custom init scripts
- Configured services (MPD, module loading)
- Managed configuration files

✅ **Build System:**
- Performed full Buildroot build
- Did incremental rebuilds for efficiency
- Cleaned specific packages
- Generated filesystem images

✅ **Dependency Analysis:**
- Generated dependency graphs
- Analyzed package relationships
- Identified build-time vs. runtime dependencies
- Understood size contributions

✅ **Integration and Testing:**
- Deployed Buildroot-generated system via NFS
- Tested all components (kernel, modules, packages)
- Verified functionality (audio, input devices, modules)

✅ **Best Practices:**
- Root filesystem overlays for customization
- External tree for maintainability
- Defconfig files for reproducibility
- Configuration fragments for modularity

## Going Further

### Recommended Reading

**Buildroot Documentation:**
- Buildroot User Manual: `docs/manual/manual.html`
- Package development guide
- Buildroot internals

**Advanced Topics:**
- Creating custom package infrastructures
- Licensing compliance with `make legal-info`
- SDK generation for application developers

### Next Steps

In **Lab 9: Application Development and Debugging**, you'll:
- Cross-compile custom applications
- Debug with gdb, gdbserver, strace, ltrace
- Use Visual Studio Code for remote debugging
- Profile with perf
- Implement MPD client controlled by Nunchuk

---

**Estimated Completion Time:** 4-5 hours

**Difficulty:** ⭐⭐⭐⭐☆ (Advanced)

**Prerequisites Met:** ✅ Lab 7 (Block Filesystems)

**Leads to:** Lab 9 (Application Development and Debugging)
