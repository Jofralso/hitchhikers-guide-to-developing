
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A structured meta-repository for learning systems engineering, embedded Linux, and infrastructure automation">
      
      
        <meta name="author" content="Jofralso">
      
      
        <link rel="canonical" href="https://jofralso.github.io/hitchhikers-guide-to-developing/labs/debugging/lab23-perf-ftrace/">
      
      
        <link rel="prev" href="../lab22-valgrind/">
      
      
        <link rel="next" href="../lab24-ebpf-bcc/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Lab 23 - perf & ftrace - The Hitchhiker's Guide to Developing</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab-23-performance-profiling-and-system-tracing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="The Hitchhiker&#39;s Guide to Developing" class="md-header__button md-logo" aria-label="The Hitchhiker's Guide to Developing" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            The Hitchhiker's Guide to Developing
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lab 23 - perf & ftrace
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="deep-orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Jofralso/hitchhikers-guide-to-developing" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    Jofralso/hitchhikers-guide-to-developing
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../QUICK_START/" class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../embedded-linux/" class="md-tabs__link">
          
  
  
  Labs

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../THE-JOURNEY/" class="md-tabs__link">
        
  
  
    
  
  The Journey

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../ROADMAP/" class="md-tabs__link">
        
  
  
    
  
  Roadmap

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../ARCHITECTURE/" class="md-tabs__link">
        
  
  
    
  
  Architecture

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../BIBLIOGRAPHY/" class="md-tabs__link">
        
  
  
    
  
  Bibliography

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../submodules/index.md" class="md-tabs__link">
          
  
  
  Submodules

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../templates/lab-template/" class="md-tabs__link">
          
  
  
  Templates

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../standards/documentation-standards/" class="md-tabs__link">
          
  
  
  Standards

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../CONTRIBUTING/" class="md-tabs__link">
        
  
  
    
  
  Contributing

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="The Hitchhiker&#39;s Guide to Developing" class="md-nav__button md-logo" aria-label="The Hitchhiker's Guide to Developing" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    The Hitchhiker's Guide to Developing
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Jofralso/hitchhikers-guide-to-developing" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    Jofralso/hitchhikers-guide-to-developing
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../QUICK_START/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BEAGLEPLAY_SETUP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    BeaglePlay Setup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../LAB_STRUCTURE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab Structure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Labs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Labs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Embedded Linux
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Embedded Linux
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/lab01-toolchain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 1 - Toolchain
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/lab02-hardware/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 2 - Hardware Discovery
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/lab03-bootloader/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 3 - U-Boot Bootloader
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/lab04-kernel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 4 - Linux Kernel
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/lab05-rootfs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 5 - Root Filesystem
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/lab06-hardware/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 6 - Hardware Devices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/lab07-block-filesystems/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 7 - Block Filesystems
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/lab08-buildroot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 8 - Buildroot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/lab09-application-development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 9 - App Development
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Yocto Project
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Yocto Project
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/lab10-yocto-first-build/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 10 - First Yocto Build
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/lab11-yocto-advanced-config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 11 - Advanced Config
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/lab12-yocto-custom-app/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 12 - Custom Application
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/lab13-yocto-custom-layer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 13 - Custom Layer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/lab14-yocto-extend-recipe/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 14 - Extend Recipe
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/lab15-yocto-custom-machine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 15 - Custom Machine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/lab16-yocto-custom-image/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 16 - Custom Image
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/lab17-yocto-app-development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 17 - SDK Development
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/lab18-yocto-devtool/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 18 - Devtool
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Debugging
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Debugging
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab19-system-monitoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 19 - System Monitoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab20-gdb-debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 20 - GDB Debugging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab21-strace-ltrace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 21 - strace/ltrace
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab22-valgrind/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 22 - Valgrind
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Lab 23 - perf & ftrace
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 23 - perf & ftrace
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dont-panic" class="md-nav__link">
    <span class="md-ellipsis">
      
        DON'T PANIC
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#objectives" class="md-nav__link">
    <span class="md-ellipsis">
      
        Objectives
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisites
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-introduction-to-perf" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Introduction to perf
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Introduction to perf">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-what-is-perf" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 What is perf?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-install-perf" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 Install perf
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-kernel-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.3 Kernel Configuration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-basic-perf-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Basic perf Usage
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Basic perf Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-record-performance-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 Record Performance Data
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-analyze-recorded-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 Analyze Recorded Data
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-create-test-program" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3 Create Test Program
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-advanced-perf-features" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Advanced perf Features
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Advanced perf Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-call-graph-profiling" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 Call Graph Profiling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-hardware-performance-counters" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 Hardware Performance Counters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-top-like-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.3 Top-like Monitoring
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-flame-graphs" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Flame Graphs
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Flame Graphs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-install-flamegraph-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 Install FlameGraph Tools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-generate-flame-graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 Generate Flame Graph
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-interpret-flame-graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3 Interpret Flame Graph
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-introduction-to-ftrace" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Introduction to ftrace
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Introduction to ftrace">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-what-is-ftrace" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1 What is ftrace?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-enable-ftrace" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.2 Enable ftrace
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53-basic-ftrace-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.3 Basic ftrace Usage
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-function-graph-tracer" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Function Graph Tracer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Function Graph Tracer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-trace-function-calls" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 Trace Function Calls
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-filter-specific-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 Filter Specific Functions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-trace-cmd-ftrace-frontend" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. trace-cmd (ftrace Frontend)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. trace-cmd (ftrace Frontend)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-install-trace-cmd" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.1 Install trace-cmd
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-record-trace" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2 Record Trace
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73-report-trace" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.3 Report Trace
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-kernelshark-visualization" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. KernelShark Visualization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. KernelShark Visualization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-install-kernelshark" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.1 Install KernelShark
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-view-trace" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.2 View Trace
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-userspace-probing-uprobes" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. Userspace Probing (uprobes)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Userspace Probing (uprobes)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91-trace-userspace-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1 Trace Userspace Functions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92-trace-with-arguments" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2 Trace with Arguments
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-performance-analysis-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        10. Performance Analysis Workflow
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10. Performance Analysis Workflow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101-identify-bottleneck" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.1 Identify Bottleneck
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102-fix-and-verify" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.2 Fix and Verify
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-advanced-perf-recipes" class="md-nav__link">
    <span class="md-ellipsis">
      
        11. Advanced perf Recipes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11. Advanced perf Recipes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111-off-cpu-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.1 Off-CPU Analysis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112-lock-contention" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.2 Lock Contention
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113-context-switch-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.3 Context Switch Analysis
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-kernel-configuration-for-tracing" class="md-nav__link">
    <span class="md-ellipsis">
      
        12. Kernel Configuration for Tracing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12. Kernel Configuration for Tracing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121-required-kernel-configs" class="md-nav__link">
    <span class="md-ellipsis">
      
        12.1 Required Kernel Configs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122-enable-in-yocto" class="md-nav__link">
    <span class="md-ellipsis">
      
        12.2 Enable in Yocto
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-real-world-example-optimize-http-server" class="md-nav__link">
    <span class="md-ellipsis">
      
        13. Real-World Example: Optimize HTTP Server
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-key-takeaways" class="md-nav__link">
    <span class="md-ellipsis">
      
        14. Key Takeaways
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-verification-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      
        15. Verification Checklist
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab24-ebpf-bcc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 24 - eBPF & BCC
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab25-kernel-debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 25 - Kernel Debugging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab26-kdump-kexec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 26 - kdump & kexec
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../THE-JOURNEY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    The Journey
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ROADMAP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Roadmap
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ARCHITECTURE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BIBLIOGRAPHY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bibliography
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Submodules
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Submodules
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../submodules/index.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Templates
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Templates
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../templates/lab-template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab Template
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../templates/research-note/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Research Note
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../templates/technical-procedure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Technical Procedure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Standards
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Standards
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../standards/documentation-standards/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Documentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CONTRIBUTING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dont-panic" class="md-nav__link">
    <span class="md-ellipsis">
      
        DON'T PANIC
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#objectives" class="md-nav__link">
    <span class="md-ellipsis">
      
        Objectives
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisites
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-introduction-to-perf" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Introduction to perf
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Introduction to perf">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-what-is-perf" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 What is perf?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-install-perf" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 Install perf
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-kernel-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.3 Kernel Configuration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-basic-perf-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Basic perf Usage
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Basic perf Usage">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-record-performance-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 Record Performance Data
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-analyze-recorded-data" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 Analyze Recorded Data
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-create-test-program" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3 Create Test Program
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-advanced-perf-features" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Advanced perf Features
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Advanced perf Features">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-call-graph-profiling" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 Call Graph Profiling
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-hardware-performance-counters" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 Hardware Performance Counters
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-top-like-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.3 Top-like Monitoring
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-flame-graphs" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Flame Graphs
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Flame Graphs">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-install-flamegraph-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 Install FlameGraph Tools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-generate-flame-graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 Generate Flame Graph
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-interpret-flame-graph" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3 Interpret Flame Graph
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-introduction-to-ftrace" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Introduction to ftrace
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Introduction to ftrace">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-what-is-ftrace" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1 What is ftrace?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-enable-ftrace" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.2 Enable ftrace
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53-basic-ftrace-usage" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.3 Basic ftrace Usage
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-function-graph-tracer" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Function Graph Tracer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Function Graph Tracer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-trace-function-calls" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 Trace Function Calls
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-filter-specific-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 Filter Specific Functions
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-trace-cmd-ftrace-frontend" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. trace-cmd (ftrace Frontend)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. trace-cmd (ftrace Frontend)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-install-trace-cmd" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.1 Install trace-cmd
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-record-trace" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2 Record Trace
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73-report-trace" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.3 Report Trace
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-kernelshark-visualization" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. KernelShark Visualization
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. KernelShark Visualization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-install-kernelshark" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.1 Install KernelShark
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-view-trace" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.2 View Trace
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-userspace-probing-uprobes" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. Userspace Probing (uprobes)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Userspace Probing (uprobes)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91-trace-userspace-functions" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1 Trace Userspace Functions
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92-trace-with-arguments" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2 Trace with Arguments
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-performance-analysis-workflow" class="md-nav__link">
    <span class="md-ellipsis">
      
        10. Performance Analysis Workflow
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10. Performance Analysis Workflow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101-identify-bottleneck" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.1 Identify Bottleneck
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102-fix-and-verify" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.2 Fix and Verify
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-advanced-perf-recipes" class="md-nav__link">
    <span class="md-ellipsis">
      
        11. Advanced perf Recipes
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11. Advanced perf Recipes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#111-off-cpu-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.1 Off-CPU Analysis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#112-lock-contention" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.2 Lock Contention
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#113-context-switch-analysis" class="md-nav__link">
    <span class="md-ellipsis">
      
        11.3 Context Switch Analysis
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-kernel-configuration-for-tracing" class="md-nav__link">
    <span class="md-ellipsis">
      
        12. Kernel Configuration for Tracing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12. Kernel Configuration for Tracing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#121-required-kernel-configs" class="md-nav__link">
    <span class="md-ellipsis">
      
        12.1 Required Kernel Configs
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#122-enable-in-yocto" class="md-nav__link">
    <span class="md-ellipsis">
      
        12.2 Enable in Yocto
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#13-real-world-example-optimize-http-server" class="md-nav__link">
    <span class="md-ellipsis">
      
        13. Real-World Example: Optimize HTTP Server
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-key-takeaways" class="md-nav__link">
    <span class="md-ellipsis">
      
        14. Key Takeaways
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-verification-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      
        15. Verification Checklist
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="lab-23-performance-profiling-and-system-tracing">Lab 23: Performance Profiling and System Tracing<a class="headerlink" href="#lab-23-performance-profiling-and-system-tracing" title="Permanent link">&para;</a></h1>
<h2 id="dont-panic">DON'T PANIC<a class="headerlink" href="#dont-panic" title="Permanent link">&para;</a></h2>
<p>The Hitchhiker's Guide to Embedded Linux has this to say about performance profiling:</p>
<p><em>"Performance profiling reveals where your program spends its time. Often, you'll discover it's spending most of its time in the last place you'd expect - rather like finding that Slartibartfast spent more time on Norway's fjords than on the award-winning coastline of Africa."</em></p>
<h2 id="objectives">Objectives<a class="headerlink" href="#objectives" title="Permanent link">&para;</a></h2>
<p>Master system-wide performance profiling with <code>perf</code>, function tracing with <code>ftrace</code>, and advanced visualization tools to identify CPU hotspots and optimize performance.</p>
<p><strong>What You'll Learn:</strong>
- Profile CPU usage with <code>perf</code>
- Generate flame graphs for visualization
- Use ftrace for function-level kernel tracing
- Trace with trace-cmd and visualize with KernelShark
- Profile userspace with uprobes
- Analyze lock contention and context switches</p>
<p><strong>Time Required:</strong> 4-5 hours</p>
<hr />
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h2>
<p><strong>Hardware:</strong>
- BeaglePlay board
- Development workstation
- Network connection</p>
<p><strong>Software:</strong>
- Linux kernel with perf and ftrace support
- perf-tools package
- Python for flame graph generation</p>
<hr />
<h2 id="1-introduction-to-perf">1. Introduction to perf<a class="headerlink" href="#1-introduction-to-perf" title="Permanent link">&para;</a></h2>
<h3 id="11-what-is-perf">1.1 What is perf?<a class="headerlink" href="#11-what-is-perf" title="Permanent link">&para;</a></h3>
<p><strong><code>perf</code></strong> is Linux's performance profiling tool using hardware performance counters and software events.</p>
<p><strong>Capabilities:</strong>
- CPU profiling (sampling)
- Hardware counter access (cache misses, branch mispredictions)
- Kernel and userspace profiling
- Flamegraph generation</p>
<h3 id="12-install-perf">1.2 Install perf<a class="headerlink" href="#12-install-perf" title="Permanent link">&para;</a></h3>
<p><strong>On BeaglePlay:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1"># Buildroot: Enable in kernel config</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="nv">BR2_LINUX_KERNEL_TOOL_PERF</span><span class="o">=</span>y
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="c1"># Yocto: Add to image</span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>IMAGE_INSTALL:append<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot; perf&quot;</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a><span class="c1"># Check installation</span>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>perf<span class="w"> </span>--version
</code></pre></div></p>
<h3 id="13-kernel-configuration">1.3 Kernel Configuration<a class="headerlink" href="#13-kernel-configuration" title="Permanent link">&para;</a></h3>
<p><strong>Required kernel configs:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>CONFIG_PERF_EVENTS=y
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>CONFIG_DEBUG_KERNEL=y
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>CONFIG_KALLSYMS=y
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>CONFIG_KALLSYMS_ALL=y
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>CONFIG_DEBUG_INFO=y
</code></pre></div></p>
<p><strong>Verify:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>cat<span class="w"> </span>/boot/config-<span class="k">$(</span>uname<span class="w"> </span>-r<span class="k">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>CONFIG_PERF_EVENTS
</code></pre></div></p>
<hr />
<h2 id="2-basic-perf-usage">2. Basic perf Usage<a class="headerlink" href="#2-basic-perf-usage" title="Permanent link">&para;</a></h2>
<h3 id="21-record-performance-data">2.1 Record Performance Data<a class="headerlink" href="#21-record-performance-data" title="Permanent link">&para;</a></h3>
<p><strong>Profile entire system:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>perf<span class="w"> </span>record<span class="w"> </span>-a<span class="w"> </span>sleep<span class="w"> </span><span class="m">10</span>
</code></pre></div></p>
<p><strong>Options:</strong>
- <code>-a</code>: All CPUs
- <code>-g</code>: Capture call graphs
- <code>-F 999</code>: Sample at 999 Hz</p>
<p><strong>Profile specific command:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>perf<span class="w"> </span>record<span class="w"> </span>-g<span class="w"> </span>./my-app
</code></pre></div></p>
<p><strong>Outputs <code>perf.data</code> file.</strong></p>
<h3 id="22-analyze-recorded-data">2.2 Analyze Recorded Data<a class="headerlink" href="#22-analyze-recorded-data" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a>perf<span class="w"> </span>report
</code></pre></div>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>Samples: 45K of event &#39;cpu-clock:pppH&#39;, Event count (approx.): 11250000000
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a>Overhead  Command    Shared Object       Symbol
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a>  45.23%  my-app     my-app              [.] compute_heavy_function
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a>  12.34%  my-app     libc-2.31.so        [.] memcpy
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a>   8.45%  my-app     my-app              [.] process_data
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a>   5.67%  my-app     [kernel.kallsyms]   [k] copy_user_enhanced_fast_string
</code></pre></div></p>
<p><strong>Columns:</strong>
- <strong>Overhead</strong>: % of CPU time
- <strong>Symbol</strong>: Function name
- <code>[.]</code> = userspace, <code>[k]</code> = kernel</p>
<p><strong>Interactive navigation:</strong>
- <code>Enter</code>: Drill into function
- <code>a</code>: Annotate (show assembly)
- <code>q</code>: Quit</p>
<h3 id="23-create-test-program">2.3 Create Test Program<a class="headerlink" href="#23-create-test-program" title="Permanent link">&para;</a></h3>
<p><strong>Create <code>cpu_hog.c</code>:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="kt">void</span><span class="w"> </span><span class="nf">inefficient_sort</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">arr</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">    </span><span class="c1">// O(n) bubble sort</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#__codelineno-7-8"></a><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#__codelineno-7-9"></a><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#__codelineno-7-10"></a><span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#__codelineno-7-11"></a><span class="w">                </span><span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#__codelineno-7-12"></a><span class="w">                </span><span class="n">arr</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#__codelineno-7-13"></a><span class="w">            </span><span class="p">}</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#__codelineno-7-14"></a><span class="w">        </span><span class="p">}</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#__codelineno-7-15"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#__codelineno-7-16"></a><span class="p">}</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#__codelineno-7-17"></a>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#__codelineno-7-18"></a><span class="kt">void</span><span class="w"> </span><span class="nf">fast_memset</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#__codelineno-7-19"></a><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#__codelineno-7-20"></a><span class="p">}</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#__codelineno-7-21"></a>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#__codelineno-7-22"></a><span class="kt">void</span><span class="w"> </span><span class="nf">slow_memset</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#__codelineno-7-23"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">size</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#__codelineno-7-24"></a><span class="w">        </span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#__codelineno-7-25"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#__codelineno-7-26"></a><span class="p">}</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#__codelineno-7-27"></a>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#__codelineno-7-28"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#__codelineno-7-29"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;CPU profiling test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#__codelineno-7-30"></a>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#__codelineno-7-31"></a><span class="w">    </span><span class="c1">// Spend time in inefficient_sort</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#__codelineno-7-32"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="n">arr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">5000</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">));</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#__codelineno-7-33"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5000</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span><span class="p">();</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#__codelineno-7-34"></a><span class="w">    </span><span class="n">inefficient_sort</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span><span class="w"> </span><span class="mi">5000</span><span class="p">);</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#__codelineno-7-35"></a>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#__codelineno-7-36"></a><span class="w">    </span><span class="c1">// Spend time in memset functions</span>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#__codelineno-7-37"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">);</span>
<a id="__codelineno-7-38" name="__codelineno-7-38" href="#__codelineno-7-38"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-39" name="__codelineno-7-39" href="#__codelineno-7-39"></a><span class="w">        </span><span class="n">fast_memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">);</span>
<a id="__codelineno-7-40" name="__codelineno-7-40" href="#__codelineno-7-40"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-41" name="__codelineno-7-41" href="#__codelineno-7-41"></a><span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-42" name="__codelineno-7-42" href="#__codelineno-7-42"></a><span class="w">        </span><span class="n">slow_memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="mi">1024</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1024</span><span class="p">);</span>
<a id="__codelineno-7-43" name="__codelineno-7-43" href="#__codelineno-7-43"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-7-44" name="__codelineno-7-44" href="#__codelineno-7-44"></a>
<a id="__codelineno-7-45" name="__codelineno-7-45" href="#__codelineno-7-45"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">arr</span><span class="p">);</span>
<a id="__codelineno-7-46" name="__codelineno-7-46" href="#__codelineno-7-46"></a><span class="w">    </span><span class="n">free</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<a id="__codelineno-7-47" name="__codelineno-7-47" href="#__codelineno-7-47"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-7-48" name="__codelineno-7-48" href="#__codelineno-7-48"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Compile:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>aarch64-linux-gnu-gcc<span class="w"> </span>-g<span class="w"> </span>-O2<span class="w"> </span>-o<span class="w"> </span>cpu_hog<span class="w"> </span>cpu_hog.c
</code></pre></div></p>
<p><strong>Profile:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>perf<span class="w"> </span>record<span class="w"> </span>-g<span class="w"> </span>./cpu_hog
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>perf<span class="w"> </span>report
</code></pre></div></p>
<hr />
<h2 id="3-advanced-perf-features">3. Advanced perf Features<a class="headerlink" href="#3-advanced-perf-features" title="Permanent link">&para;</a></h2>
<h3 id="31-call-graph-profiling">3.1 Call Graph Profiling<a class="headerlink" href="#31-call-graph-profiling" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>perf<span class="w"> </span>record<span class="w"> </span>-g<span class="w"> </span>--call-graph<span class="w"> </span>dwarf<span class="w"> </span>./cpu_hog
</code></pre></div>
<p><strong>View call graph in report:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>- 45.23% inefficient_sort
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>   - main
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>      - __libc_start_main
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>         - _start
</code></pre></div></p>
<p><strong>Shows complete call chain.</strong></p>
<h3 id="32-hardware-performance-counters">3.2 Hardware Performance Counters<a class="headerlink" href="#32-hardware-performance-counters" title="Permanent link">&para;</a></h3>
<p><strong>List available events:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>perf<span class="w"> </span>list
</code></pre></div></p>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>Hardware event:
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>  cycles                     [Hardware event]
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>  instructions               [Hardware event]
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>  cache-references           [Hardware event]
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>  cache-misses               [Hardware event]
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>  branch-instructions        [Hardware event]
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>  branch-misses              [Hardware event]
</code></pre></div></p>
<p><strong>Profile cache misses:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>perf<span class="w"> </span>stat<span class="w"> </span>-e<span class="w"> </span>cache-references,cache-misses<span class="w"> </span>./cpu_hog
</code></pre></div></p>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a> Performance counter stats for &#39;./cpu_hog&#39;:
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>        45,678,901      cache-references
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a>         5,678,012      cache-misses      #   12.43% of all cache refs
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>       2.345678901 seconds time elapsed
</code></pre></div></p>
<p><strong>12% cache miss rate</strong> indicates poor cache locality.</p>
<h3 id="33-top-like-monitoring">3.3 Top-like Monitoring<a class="headerlink" href="#33-top-like-monitoring" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>perf<span class="w"> </span>top
</code></pre></div>
<p><strong>Real-time CPU hotspot display:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>Samples: 12K of event &#39;cpu-clock:pppH&#39;, 4000 Hz, Event count (approx.): 3056250000
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a>Overhead  Shared Object       Symbol
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a>  45.23%  cpu_hog             [.] inefficient_sort
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a>  12.34%  libc-2.31.so        [.] memset
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a>   5.67%  [kernel]            [k] finish_task_switch
</code></pre></div></p>
<p><strong>Updated live as program runs.</strong></p>
<hr />
<h2 id="4-flame-graphs">4. Flame Graphs<a class="headerlink" href="#4-flame-graphs" title="Permanent link">&para;</a></h2>
<h3 id="41-install-flamegraph-tools">4.1 Install FlameGraph Tools<a class="headerlink" href="#41-install-flamegraph-tools" title="Permanent link">&para;</a></h3>
<p><strong>On workstation:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/brendangregg/FlameGraph
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="nb">cd</span><span class="w"> </span>FlameGraph
</code></pre></div></p>
<h3 id="42-generate-flame-graph">4.2 Generate Flame Graph<a class="headerlink" href="#42-generate-flame-graph" title="Permanent link">&para;</a></h3>
<p><strong>Capture perf data:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>perf<span class="w"> </span>record<span class="w"> </span>-F<span class="w"> </span><span class="m">99</span><span class="w"> </span>-a<span class="w"> </span>-g<span class="w"> </span>--<span class="w"> </span>sleep<span class="w"> </span><span class="m">30</span>
</code></pre></div></p>
<p><strong>Convert to flame graph:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>perf<span class="w"> </span>script<span class="w"> </span><span class="p">|</span><span class="w"> </span>./FlameGraph/stackcollapse-perf.pl<span class="w"> </span><span class="p">|</span><span class="w"> </span>./FlameGraph/flamegraph.pl<span class="w"> </span>&gt;<span class="w"> </span>flame.svg
</code></pre></div></p>
<p><strong>View in browser:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>firefox<span class="w"> </span>flame.svg
</code></pre></div></p>
<p><strong>Flame graph visualization:</strong>
- X-axis: Alphabetical order (not time!)
- Y-axis: Stack depth
- Width: Time spent in function
- Color: Random (for differentiation)</p>
<p><strong>Click to zoom</strong> into specific call stacks.</p>
<h3 id="43-interpret-flame-graph">4.3 Interpret Flame Graph<a class="headerlink" href="#43-interpret-flame-graph" title="Permanent link">&para;</a></h3>
<p><strong>Wide plateaus</strong> = CPU hotspots (optimization targets)</p>
<p><strong>Example:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a>|----------------------- main() -----------------------|
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a>|         |------ inefficient_sort() ------|
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>|         |   |---- many recursive calls ---|
</code></pre></div></p>
<p><strong><code>inefficient_sort()</code> occupies large width</strong> = high CPU usage.</p>
<hr />
<h2 id="5-introduction-to-ftrace">5. Introduction to ftrace<a class="headerlink" href="#5-introduction-to-ftrace" title="Permanent link">&para;</a></h2>
<h3 id="51-what-is-ftrace">5.1 What is ftrace?<a class="headerlink" href="#51-what-is-ftrace" title="Permanent link">&para;</a></h3>
<p><strong>ftrace</strong> is the kernel's built-in function tracer.</p>
<p><strong>Features:</strong>
- Trace kernel functions
- Measure function latency
- Create custom trace events
- Zero overhead when disabled</p>
<h3 id="52-enable-ftrace">5.2 Enable ftrace<a class="headerlink" href="#52-enable-ftrace" title="Permanent link">&para;</a></h3>
<p><strong>Check if available:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>mount<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>tracefs
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="c1"># tracefs on /sys/kernel/tracing type tracefs (rw,relatime)</span>
</code></pre></div></p>
<p><strong>Or mount manually:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>mount<span class="w"> </span>-t<span class="w"> </span>tracefs<span class="w"> </span>nodev<span class="w"> </span>/sys/kernel/tracing
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="nb">cd</span><span class="w"> </span>/sys/kernel/tracing
</code></pre></div></p>
<h3 id="53-basic-ftrace-usage">5.3 Basic ftrace Usage<a class="headerlink" href="#53-basic-ftrace-usage" title="Permanent link">&para;</a></h3>
<p><strong>List available tracers:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>cat<span class="w"> </span>/sys/kernel/tracing/available_tracers
</code></pre></div></p>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>function_graph function nop
</code></pre></div></p>
<p><strong>Enable function tracer:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="nb">echo</span><span class="w"> </span><span class="k">function</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/tracing/current_tracer
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/tracing/tracing_on
</code></pre></div></p>
<p><strong>View trace:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>cat<span class="w"> </span>/sys/kernel/tracing/trace<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-20
</code></pre></div></p>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a># tracer: function
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>#
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a># entries-in-buffer/entries-written: 45678/2345678   #P:4
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>#
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>#           TASK-PID   CPU#  TIMESTAMP  FUNCTION
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a>#              | |       |      |         |
<a id="__codelineno-29-7" name="__codelineno-29-7" href="#__codelineno-29-7"></a>          &lt;idle&gt;-0     [000] 123.456789: rcu_idle_exit &lt;-cpu_startup_entry
<a id="__codelineno-29-8" name="__codelineno-29-8" href="#__codelineno-29-8"></a>          &lt;idle&gt;-0     [000] 123.456790: arch_cpu_idle_exit &lt;-cpu_startup_entry
<a id="__codelineno-29-9" name="__codelineno-29-9" href="#__codelineno-29-9"></a>          &lt;idle&gt;-0     [000] 123.456791: tick_nohz_idle_exit &lt;-cpu_startup_entry
</code></pre></div></p>
<p><strong>Disable tracing:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/tracing/tracing_on
</code></pre></div></p>
<hr />
<h2 id="6-function-graph-tracer">6. Function Graph Tracer<a class="headerlink" href="#6-function-graph-tracer" title="Permanent link">&para;</a></h2>
<h3 id="61-trace-function-calls">6.1 Trace Function Calls<a class="headerlink" href="#61-trace-function-calls" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="nb">echo</span><span class="w"> </span>function_graph<span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/tracing/current_tracer
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/tracing/tracing_on
<a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a>sleep<span class="w"> </span><span class="m">1</span>
<a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a><span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/tracing/tracing_on
<a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>cat<span class="w"> </span>/sys/kernel/tracing/trace<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-50
</code></pre></div>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a> 0)               |  sys_read() {
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a> 0)               |    vfs_read() {
<a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a> 0)               |      rw_verify_area() {
<a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a> 0)   0.234 us    |        security_file_permission();
<a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a> 0)   1.234 us    |      }
<a id="__codelineno-32-6" name="__codelineno-32-6" href="#__codelineno-32-6"></a> 0)               |      __vfs_read() {
<a id="__codelineno-32-7" name="__codelineno-32-7" href="#__codelineno-32-7"></a> 0)  12.345 us    |        ext4_file_read_iter();
<a id="__codelineno-32-8" name="__codelineno-32-8" href="#__codelineno-32-8"></a> 0)  13.567 us    |      }
<a id="__codelineno-32-9" name="__codelineno-32-9" href="#__codelineno-32-9"></a> 0)  16.789 us    |    }
<a id="__codelineno-32-10" name="__codelineno-32-10" href="#__codelineno-32-10"></a> 0)  18.012 us    |  }
</code></pre></div></p>
<p><strong>Shows call hierarchy and duration.</strong></p>
<h3 id="62-filter-specific-functions">6.2 Filter Specific Functions<a class="headerlink" href="#62-filter-specific-functions" title="Permanent link">&para;</a></h3>
<p><strong>Trace only a specific function:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="nb">echo</span><span class="w"> </span>schedule<span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/tracing/set_ftrace_filter
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="nb">echo</span><span class="w"> </span><span class="k">function</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/tracing/current_tracer
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/tracing/tracing_on
</code></pre></div></p>
<p><strong>Clear filter:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="nb">echo</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/tracing/set_ftrace_filter
</code></pre></div></p>
<hr />
<h2 id="7-trace-cmd-ftrace-frontend">7. trace-cmd (ftrace Frontend)<a class="headerlink" href="#7-trace-cmd-ftrace-frontend" title="Permanent link">&para;</a></h2>
<h3 id="71-install-trace-cmd">7.1 Install trace-cmd<a class="headerlink" href="#71-install-trace-cmd" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="c1"># Yocto</span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>IMAGE_INSTALL:append<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot; trace-cmd kernelshark&quot;</span>
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>
<a id="__codelineno-35-4" name="__codelineno-35-4" href="#__codelineno-35-4"></a><span class="c1"># Buildroot</span>
<a id="__codelineno-35-5" name="__codelineno-35-5" href="#__codelineno-35-5"></a>make<span class="w"> </span>menuconfig
<a id="__codelineno-35-6" name="__codelineno-35-6" href="#__codelineno-35-6"></a><span class="c1"># Target packages -&gt; Debugging -&gt; trace-cmd</span>
<a id="__codelineno-35-7" name="__codelineno-35-7" href="#__codelineno-35-7"></a>
<a id="__codelineno-35-8" name="__codelineno-35-8" href="#__codelineno-35-8"></a><span class="c1"># Verify</span>
<a id="__codelineno-35-9" name="__codelineno-35-9" href="#__codelineno-35-9"></a>trace-cmd<span class="w"> </span>--version
</code></pre></div>
<h3 id="72-record-trace">7.2 Record Trace<a class="headerlink" href="#72-record-trace" title="Permanent link">&para;</a></h3>
<p><strong>System-wide trace:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a>trace-cmd<span class="w"> </span>record<span class="w"> </span>-e<span class="w"> </span>sched<span class="w"> </span>-e<span class="w"> </span>syscalls<span class="w"> </span>-a<span class="w"> </span>sleep<span class="w"> </span><span class="m">5</span>
</code></pre></div></p>
<p><strong>Options:</strong>
- <code>-e sched</code>: Scheduler events
- <code>-e syscalls</code>: System calls
- <code>-a</code>: All CPUs</p>
<p><strong>Creates <code>trace.dat</code> file.</strong></p>
<h3 id="73-report-trace">7.3 Report Trace<a class="headerlink" href="#73-report-trace" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a>trace-cmd<span class="w"> </span>report<span class="w"> </span>trace.dat<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-50
</code></pre></div>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a>cpus=4
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a>     sleep-567   [000] 123.456789: sys_nanosleep: 
<a id="__codelineno-38-3" name="__codelineno-38-3" href="#__codelineno-38-3"></a>     sleep-567   [000] 123.456790: sched_switch: prev_comm=sleep prev_pid=567 ==&gt; next_comm=swapper/0
<a id="__codelineno-38-4" name="__codelineno-38-4" href="#__codelineno-38-4"></a>     &lt;idle&gt;-0     [000] 128.456789: sched_switch: prev_comm=swapper/0 ==&gt; next_comm=sleep next_pid=567
<a id="__codelineno-38-5" name="__codelineno-38-5" href="#__codelineno-38-5"></a>     sleep-567   [000] 128.456790: sys_exit: ret=0
</code></pre></div></p>
<hr />
<h2 id="8-kernelshark-visualization">8. KernelShark Visualization<a class="headerlink" href="#8-kernelshark-visualization" title="Permanent link">&para;</a></h2>
<h3 id="81-install-kernelshark">8.1 Install KernelShark<a class="headerlink" href="#81-install-kernelshark" title="Permanent link">&para;</a></h3>
<p><strong>On workstation:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>kernelshark
</code></pre></div></p>
<h3 id="82-view-trace">8.2 View Trace<a class="headerlink" href="#82-view-trace" title="Permanent link">&para;</a></h3>
<p><strong>Transfer trace.dat from BeaglePlay:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a>scp<span class="w"> </span>root@192.168.0.100:/root/trace.dat<span class="w"> </span>.
</code></pre></div></p>
<p><strong>Open in KernelShark:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a>kernelshark<span class="w"> </span>trace.dat
</code></pre></div></p>
<p><strong>GUI shows:</strong>
- Timeline view of events
- CPU utilization graphs
- Task scheduling visualization
- Filterable by event type</p>
<p><strong>Interactive features:</strong>
- Zoom in/out
- Search events
- Filter by task/CPU
- Measure time intervals</p>
<hr />
<h2 id="9-userspace-probing-uprobes">9. Userspace Probing (uprobes)<a class="headerlink" href="#9-userspace-probing-uprobes" title="Permanent link">&para;</a></h2>
<h3 id="91-trace-userspace-functions">9.1 Trace Userspace Functions<a class="headerlink" href="#91-trace-userspace-functions" title="Permanent link">&para;</a></h3>
<p><strong>Add uprobe for function in binary:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="c1"># Find function address</span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a>nm<span class="w"> </span>cpu_hog<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>inefficient_sort
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a><span class="c1"># 0000000000001234 T inefficient_sort</span>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="c1"># Add uprobe</span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;p:my_probe /tmp/cpu_hog:0x1234&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/tracing/uprobe_events
<a id="__codelineno-42-7" name="__codelineno-42-7" href="#__codelineno-42-7"></a>
<a id="__codelineno-42-8" name="__codelineno-42-8" href="#__codelineno-42-8"></a><span class="c1"># Enable</span>
<a id="__codelineno-42-9" name="__codelineno-42-9" href="#__codelineno-42-9"></a><span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/tracing/events/uprobes/my_probe/enable
<a id="__codelineno-42-10" name="__codelineno-42-10" href="#__codelineno-42-10"></a>
<a id="__codelineno-42-11" name="__codelineno-42-11" href="#__codelineno-42-11"></a><span class="c1"># Run program</span>
<a id="__codelineno-42-12" name="__codelineno-42-12" href="#__codelineno-42-12"></a>./cpu_hog
<a id="__codelineno-42-13" name="__codelineno-42-13" href="#__codelineno-42-13"></a>
<a id="__codelineno-42-14" name="__codelineno-42-14" href="#__codelineno-42-14"></a><span class="c1"># View trace</span>
<a id="__codelineno-42-15" name="__codelineno-42-15" href="#__codelineno-42-15"></a>cat<span class="w"> </span>/sys/kernel/tracing/trace
</code></pre></div></p>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a>cpu_hog-567   [001] 123.456789: my_probe: (0x1234)
</code></pre></div></p>
<h3 id="92-trace-with-arguments">9.2 Trace with Arguments<a class="headerlink" href="#92-trace-with-arguments" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="nb">echo</span><span class="w"> </span><span class="s1">&#39;p:my_probe /tmp/cpu_hog:0x1234 arg1=%di arg2=%si&#39;</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/tracing/uprobe_events
</code></pre></div>
<p><strong>Captures function arguments</strong> (x86_64 calling convention: rdi, rsi, etc.).</p>
<hr />
<h2 id="10-performance-analysis-workflow">10. Performance Analysis Workflow<a class="headerlink" href="#10-performance-analysis-workflow" title="Permanent link">&para;</a></h2>
<h3 id="101-identify-bottleneck">10.1 Identify Bottleneck<a class="headerlink" href="#101-identify-bottleneck" title="Permanent link">&para;</a></h3>
<p><strong>Step 1: System-wide profiling</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a>perf<span class="w"> </span>top
</code></pre></div></p>
<p><strong>Identify hot functions.</strong></p>
<p><strong>Step 2: Detailed profiling</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a>perf<span class="w"> </span>record<span class="w"> </span>-g<span class="w"> </span>./my-app
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>perf<span class="w"> </span>report
</code></pre></div></p>
<p><strong>Find call chains leading to hotspot.</strong></p>
<p><strong>Step 3: Annotate assembly</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a>(gdb) disassemble inefficient_sort
</code></pre></div></p>
<p><strong>Or in perf report, press <code>a</code> on function.</strong></p>
<h3 id="102-fix-and-verify">10.2 Fix and Verify<a class="headerlink" href="#102-fix-and-verify" title="Permanent link">&para;</a></h3>
<p><strong>Optimize code, then re-profile:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a>perf<span class="w"> </span>stat<span class="w"> </span>-e<span class="w"> </span>cycles,instructions<span class="w"> </span>./my-app-optimized
</code></pre></div></p>
<p><strong>Compare:</strong>
- Cycles reduced?
- Instructions per cycle (IPC) improved?
- Cache misses decreased?</p>
<hr />
<h2 id="11-advanced-perf-recipes">11. Advanced perf Recipes<a class="headerlink" href="#11-advanced-perf-recipes" title="Permanent link">&para;</a></h2>
<h3 id="111-off-cpu-analysis">11.1 Off-CPU Analysis<a class="headerlink" href="#111-off-cpu-analysis" title="Permanent link">&para;</a></h3>
<p><strong>Find where tasks are blocked:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-49-1" name="__codelineno-49-1" href="#__codelineno-49-1"></a>perf<span class="w"> </span>record<span class="w"> </span>-e<span class="w"> </span>sched:sched_switch<span class="w"> </span>-a<span class="w"> </span>-g<span class="w"> </span>--<span class="w"> </span>sleep<span class="w"> </span><span class="m">10</span>
<a id="__codelineno-49-2" name="__codelineno-49-2" href="#__codelineno-49-2"></a>perf<span class="w"> </span>script<span class="w"> </span><span class="p">|</span><span class="w"> </span>./FlameGraph/stackcollapse-perf.pl<span class="w"> </span><span class="p">|</span><span class="w"> </span>./FlameGraph/flamegraph.pl<span class="w"> </span>--color<span class="o">=</span>io<span class="w"> </span>--title<span class="o">=</span><span class="s2">&quot;Off-CPU Time&quot;</span><span class="w"> </span>&gt;<span class="w"> </span>offcpu.svg
</code></pre></div></p>
<p><strong>Shows time waiting for I/O, locks, etc.</strong></p>
<h3 id="112-lock-contention">11.2 Lock Contention<a class="headerlink" href="#112-lock-contention" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-50-1" name="__codelineno-50-1" href="#__codelineno-50-1"></a>perf<span class="w"> </span>lock<span class="w"> </span>record<span class="w"> </span>-a<span class="w"> </span>--<span class="w"> </span>sleep<span class="w"> </span><span class="m">10</span>
<a id="__codelineno-50-2" name="__codelineno-50-2" href="#__codelineno-50-2"></a>perf<span class="w"> </span>lock<span class="w"> </span>report
</code></pre></div>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-51-1" name="__codelineno-51-1" href="#__codelineno-51-1"></a>Name                   acquired  contended avg wait (ns)   total wait (ns)
<a id="__codelineno-51-2" name="__codelineno-51-2" href="#__codelineno-51-2"></a>&amp;mm-&gt;mmap_sem              1234         45        123456          5555520
<a id="__codelineno-51-3" name="__codelineno-51-3" href="#__codelineno-51-3"></a>&amp;sb-&gt;s_type-&gt;i_mutex       5678        123         98765         12160095
</code></pre></div></p>
<p><strong>High contention</strong> = lock optimization needed.</p>
<h3 id="113-context-switch-analysis">11.3 Context Switch Analysis<a class="headerlink" href="#113-context-switch-analysis" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-52-1" name="__codelineno-52-1" href="#__codelineno-52-1"></a>perf<span class="w"> </span>record<span class="w"> </span>-e<span class="w"> </span>context-switches<span class="w"> </span>-a<span class="w"> </span>-g<span class="w"> </span>--<span class="w"> </span>sleep<span class="w"> </span><span class="m">10</span>
<a id="__codelineno-52-2" name="__codelineno-52-2" href="#__codelineno-52-2"></a>perf<span class="w"> </span>report
</code></pre></div>
<p><strong>High context switch rate</strong> = scheduler thrashing.</p>
<hr />
<h2 id="12-kernel-configuration-for-tracing">12. Kernel Configuration for Tracing<a class="headerlink" href="#12-kernel-configuration-for-tracing" title="Permanent link">&para;</a></h2>
<h3 id="121-required-kernel-configs">12.1 Required Kernel Configs<a class="headerlink" href="#121-required-kernel-configs" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-53-1" name="__codelineno-53-1" href="#__codelineno-53-1"></a>CONFIG_FTRACE=y
<a id="__codelineno-53-2" name="__codelineno-53-2" href="#__codelineno-53-2"></a>CONFIG_FUNCTION_TRACER=y
<a id="__codelineno-53-3" name="__codelineno-53-3" href="#__codelineno-53-3"></a>CONFIG_FUNCTION_GRAPH_TRACER=y
<a id="__codelineno-53-4" name="__codelineno-53-4" href="#__codelineno-53-4"></a>CONFIG_DYNAMIC_FTRACE=y
<a id="__codelineno-53-5" name="__codelineno-53-5" href="#__codelineno-53-5"></a>CONFIG_KPROBES=y
<a id="__codelineno-53-6" name="__codelineno-53-6" href="#__codelineno-53-6"></a>CONFIG_UPROBES=y
<a id="__codelineno-53-7" name="__codelineno-53-7" href="#__codelineno-53-7"></a>CONFIG_TRACING=y
</code></pre></div>
<h3 id="122-enable-in-yocto">12.2 Enable in Yocto<a class="headerlink" href="#122-enable-in-yocto" title="Permanent link">&para;</a></h3>
<p><strong>In <code>local.conf</code> or machine config:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-54-1" name="__codelineno-54-1" href="#__codelineno-54-1"></a>KERNEL_FEATURES:append = &quot; cfg/ftrace.cfg&quot;
</code></pre></div></p>
<hr />
<h2 id="13-real-world-example-optimize-http-server">13. Real-World Example: Optimize HTTP Server<a class="headerlink" href="#13-real-world-example-optimize-http-server" title="Permanent link">&para;</a></h2>
<p><strong>Scenario:</strong> HTTP server using too much CPU.</p>
<p><strong>Step 1: Identify hotspot</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-55-1" name="__codelineno-55-1" href="#__codelineno-55-1"></a>perf<span class="w"> </span>top
<a id="__codelineno-55-2" name="__codelineno-55-2" href="#__codelineno-55-2"></a><span class="c1"># Shows 60% in parse_http_request()</span>
</code></pre></div></p>
<p><strong>Step 2: Profile in detail</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-56-1" name="__codelineno-56-1" href="#__codelineno-56-1"></a>perf<span class="w"> </span>record<span class="w"> </span>-g<span class="w"> </span>-p<span class="w"> </span><span class="k">$(</span>pidof<span class="w"> </span>http-server<span class="k">)</span>
<a id="__codelineno-56-2" name="__codelineno-56-2" href="#__codelineno-56-2"></a><span class="c1"># Let run for 60 seconds</span>
<a id="__codelineno-56-3" name="__codelineno-56-3" href="#__codelineno-56-3"></a>perf<span class="w"> </span>report
</code></pre></div></p>
<p><strong>Step 3: Flame graph</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-57-1" name="__codelineno-57-1" href="#__codelineno-57-1"></a>perf<span class="w"> </span>script<span class="w"> </span><span class="p">|</span><span class="w"> </span>stackcollapse-perf.pl<span class="w"> </span><span class="p">|</span><span class="w"> </span>flamegraph.pl<span class="w"> </span>&gt;<span class="w"> </span>http.svg
</code></pre></div></p>
<p><strong>Analysis:</strong> Wide plateau in <code>strcmp()</code> calls.</p>
<p><strong>Step 4: Optimize</strong>
- Replace repeated <code>strcmp()</code> with hash table
- Use <code>memcmp()</code> for fixed-length fields</p>
<p><strong>Step 5: Verify</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-58-1" name="__codelineno-58-1" href="#__codelineno-58-1"></a>perf<span class="w"> </span>stat<span class="w"> </span>-p<span class="w"> </span><span class="k">$(</span>pidof<span class="w"> </span>http-server<span class="k">)</span><span class="w"> </span>sleep<span class="w"> </span><span class="m">60</span>
</code></pre></div></p>
<p><strong>Result:</strong> 40% CPU reduction.</p>
<hr />
<h2 id="14-key-takeaways">14. Key Takeaways<a class="headerlink" href="#14-key-takeaways" title="Permanent link">&para;</a></h2>
<p><strong>Accomplished:</strong>
1.  Profiled CPU usage with perf
2.  Generated and analyzed flame graphs
3.  Traced kernel functions with ftrace
4.  Visualized traces with KernelShark
5.  Used uprobes for userspace tracing
6.  Analyzed lock contention and context switches</p>
<p><strong>Essential Commands:</strong>
- <code>perf record -g ./app</code>: Profile with call graphs
- <code>perf top</code>: Real-time CPU monitoring
- <code>trace-cmd record -e sched</code>: Trace scheduler
- <code>perf script | flamegraph.pl</code>: Generate flame graph</p>
<p><strong>Next Steps:</strong>
- <strong>Lab 24</strong>: eBPF and BCC tracing
- <strong>Lab 25</strong>: Kernel debugging</p>
<hr />
<h2 id="15-verification-checklist">15. Verification Checklist<a class="headerlink" href="#15-verification-checklist" title="Permanent link">&para;</a></h2>
<ul>
<li>[ ] Can profile applications with perf</li>
<li>[ ] Can generate flame graphs</li>
<li>[ ] Understand ftrace function tracing</li>
<li>[ ] Can use trace-cmd and KernelShark</li>
<li>[ ] Can trace userspace with uprobes</li>
<li>[ ] Can identify performance bottlenecks</li>
</ul>
<hr />
<p><strong>End of Lab 23</strong></p>
<p><em>The Guide rates this lab: </em><em>Mostly Harmless</em><em> </em></p>
<p>Performance profiling is essential for building efficient systems. The combination of perf, ftrace, and visualization tools provides complete visibility into system behavior, from userspace applications to kernel internals.</p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="January 30, 2026 15:44:01 UTC">January 30, 2026</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="January 30, 2026 15:44:01 UTC">January 30, 2026</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 Jofralso. Licensed under MIT.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/Jofralso" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="https://buymeacoffee.com/jofralso" target="_blank" rel="noopener" title="Buy Me A Coffee" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M152-16c-13.3 0-24 10.7-24 24 0 38.9 23.4 59.4 39.1 73.1l1.1 1C184.5 96.4 192 103.9 192 120c0 13.3 10.7 24 24 24s24-10.7 24-24c0-38.9-23.4-59.4-39.1-73.1l-1.1-1C183.5 31.7 176 24.1 176 8c0-13.3-10.7-24-24-24M96 192c-17.7 0-32 14.3-32 32v192c0 53 43 96 96 96h192c41.8 0 77.4-26.7 90.5-64h5.5c70.7 0 128-57.3 128-128s-57.3-128-128-128zm352 192V256c35.3 0 64 28.7 64 64s-28.7 64-64 64M288 8c0-13.3-10.7-24-24-24S240-5.3 240 8c0 38.9 23.4 59.4 39.1 73.1l1.1 1C296.5 96.4 304 103.9 304 120c0 13.3 10.7 24 24 24s24-10.7 24-24c0-38.9-23.4-59.4-39.1-73.1l-1.1-1C295.5 31.7 288 24.1 288 8"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>