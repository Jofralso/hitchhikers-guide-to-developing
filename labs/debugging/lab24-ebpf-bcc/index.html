
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A structured meta-repository for learning systems engineering, embedded Linux, and infrastructure automation">
      
      
        <meta name="author" content="Jofralso">
      
      
        <link rel="canonical" href="https://jofralso.github.io/hitchhikers-guide-to-developing/labs/debugging/lab24-ebpf-bcc/">
      
      
        <link rel="prev" href="../lab23-perf-ftrace/">
      
      
        <link rel="next" href="../lab25-kernel-debugging/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>Lab 24 - eBPF & BCC - The Hitchhiker's Guide to Developing</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#lab-24-ebpf-and-bcc-tracing" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="The Hitchhiker&#39;s Guide to Developing" class="md-header__button md-logo" aria-label="The Hitchhiker's Guide to Developing" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            The Hitchhiker's Guide to Developing
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Lab 24 - eBPF & BCC
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="deep-orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/Jofralso/hitchhikers-guide-to-developing" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    Jofralso/hitchhikers-guide-to-developing
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../.." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../QUICK_START/" class="md-tabs__link">
          
  
  
  Getting Started

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../embedded-linux/" class="md-tabs__link">
          
  
  
  Labs

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../THE-JOURNEY/" class="md-tabs__link">
        
  
  
    
  
  The Journey

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../ROADMAP/" class="md-tabs__link">
        
  
  
    
  
  Roadmap

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../ARCHITECTURE/" class="md-tabs__link">
        
  
  
    
  
  Architecture

      </a>
    </li>
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../BIBLIOGRAPHY/" class="md-tabs__link">
        
  
  
    
  
  Bibliography

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../submodules/index.md" class="md-tabs__link">
          
  
  
  Submodules

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../templates/lab-template/" class="md-tabs__link">
          
  
  
  Templates

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../standards/documentation-standards/" class="md-tabs__link">
          
  
  
  Standards

        </a>
      </li>
    
  

      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../../../CONTRIBUTING/" class="md-tabs__link">
        
  
  
    
  
  Contributing

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="The Hitchhiker&#39;s Guide to Developing" class="md-nav__button md-logo" aria-label="The Hitchhiker's Guide to Developing" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    The Hitchhiker's Guide to Developing
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/Jofralso/hitchhikers-guide-to-developing" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    Jofralso/hitchhikers-guide-to-developing
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Getting Started
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../QUICK_START/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quick Start
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BEAGLEPLAY_SETUP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    BeaglePlay Setup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../LAB_STRUCTURE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab Structure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Labs
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Labs
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Embedded Linux
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Embedded Linux
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/lab01-toolchain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 1 - Toolchain
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/lab02-hardware/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 2 - Hardware Discovery
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/lab03-bootloader/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 3 - U-Boot Bootloader
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/lab04-kernel/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 4 - Linux Kernel
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/lab05-rootfs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 5 - Root Filesystem
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/lab06-hardware/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 6 - Hardware Devices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/lab07-block-filesystems/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 7 - Block Filesystems
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/lab08-buildroot/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 8 - Buildroot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../embedded-linux/lab09-application-development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 9 - App Development
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Yocto Project
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Yocto Project
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/lab10-yocto-first-build/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 10 - First Yocto Build
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/lab11-yocto-advanced-config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 11 - Advanced Config
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/lab12-yocto-custom-app/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 12 - Custom Application
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/lab13-yocto-custom-layer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 13 - Custom Layer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/lab14-yocto-extend-recipe/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 14 - Extend Recipe
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/lab15-yocto-custom-machine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 15 - Custom Machine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/lab16-yocto-custom-image/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 16 - Custom Image
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/lab17-yocto-app-development/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 17 - SDK Development
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yocto/lab18-yocto-devtool/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 18 - Devtool
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" checked>
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Debugging
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Debugging
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab19-system-monitoring/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 19 - System Monitoring
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab20-gdb-debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 20 - GDB Debugging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab21-strace-ltrace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 21 - strace/ltrace
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab22-valgrind/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 22 - Valgrind
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab23-perf-ftrace/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 23 - perf & ftrace
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Lab 24 - eBPF & BCC
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 24 - eBPF & BCC
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dont-panic" class="md-nav__link">
    <span class="md-ellipsis">
      
        DON'T PANIC
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#objectives" class="md-nav__link">
    <span class="md-ellipsis">
      
        Objectives
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisites
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-introduction-to-ebpf" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Introduction to eBPF
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Introduction to eBPF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-what-is-ebpf" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 What is eBPF?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-ebpf-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 eBPF Architecture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-kernel-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.3 Kernel Configuration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-install-bcc" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Install BCC
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Install BCC">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-bcc-on-workstation" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 BCC on Workstation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-bcc-on-beagleplay-cross-compile" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 BCC on BeaglePlay (Cross-Compile)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-pre-built-bcc-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Pre-Built BCC Tools
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Pre-Built BCC Tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-explore-available-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 Explore Available Tools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-execsnoop-trace-process-execution" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 execsnoop - Trace Process Execution
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-opensnoop-trace-file-opens" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.3 opensnoop - Trace File Opens
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-biotop-top-like-disk-io" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4 biotop - Top-Like Disk I/O
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-tcpconnect-trace-tcp-connections" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5 tcpconnect - Trace TCP Connections
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-write-custom-bcc-scripts" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Write Custom BCC Scripts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Write Custom BCC Scripts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-hello-world-bcc-program" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 Hello World BCC Program
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-count-system-calls" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 Count System Calls
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-trace-function-arguments" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3 Trace Function Arguments
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-bpf-maps-for-data-collection" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. BPF Maps for Data Collection
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. BPF Maps for Data Collection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-bpf-map-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1 BPF Map Types
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-use-hash-map-for-aggregation" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.2 Use Hash Map for Aggregation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-network-packet-tracing" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Network Packet Tracing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Network Packet Tracing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-trace-tcp-packets" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 Trace TCP Packets
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-porting-to-libbpf-embedded" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Porting to libbpf (Embedded)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Porting to libbpf (Embedded)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-why-libbpf" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.1 Why libbpf?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-write-libbpf-program" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2 Write libbpf Program
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-real-world-use-cases" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. Real-World Use Cases
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Real-World Use Cases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-detect-unauthorized-file-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.1 Detect Unauthorized File Access
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-network-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.2 Network Monitoring
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. Performance Considerations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Performance Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91-overhead-measurement" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1 Overhead Measurement
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92-optimization-tips" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2 Optimization Tips
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        10. Troubleshooting
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10. Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101-bpf-verifier-errors" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.1 BPF Verifier Errors
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102-missing-kernel-symbols" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.2 Missing Kernel Symbols
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-key-takeaways" class="md-nav__link">
    <span class="md-ellipsis">
      
        11. Key Takeaways
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-verification-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      
        12. Verification Checklist
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab25-kernel-debugging/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 25 - Kernel Debugging
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../lab26-kdump-kexec/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab 26 - kdump & kexec
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../THE-JOURNEY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    The Journey
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ROADMAP/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Roadmap
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ARCHITECTURE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../BIBLIOGRAPHY/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bibliography
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_8" >
        
          
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Submodules
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Submodules
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../submodules/index.md" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_9" >
        
          
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Templates
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            
  
    Templates
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../templates/lab-template/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lab Template
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../templates/research-note/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Research Note
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../templates/technical-procedure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Technical Procedure
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_10" >
        
          
          <label class="md-nav__link" for="__nav_10" id="__nav_10_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Standards
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_10_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    Standards
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../standards/documentation-standards/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Documentation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../CONTRIBUTING/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contributing
  

    
  </span>
  
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dont-panic" class="md-nav__link">
    <span class="md-ellipsis">
      
        DON'T PANIC
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#objectives" class="md-nav__link">
    <span class="md-ellipsis">
      
        Objectives
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#prerequisites" class="md-nav__link">
    <span class="md-ellipsis">
      
        Prerequisites
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#1-introduction-to-ebpf" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Introduction to eBPF
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. Introduction to eBPF">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-what-is-ebpf" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 What is eBPF?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-ebpf-architecture" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 eBPF Architecture
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-kernel-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.3 Kernel Configuration
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-install-bcc" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Install BCC
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Install BCC">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-bcc-on-workstation" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 BCC on Workstation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-bcc-on-beagleplay-cross-compile" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 BCC on BeaglePlay (Cross-Compile)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-pre-built-bcc-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Pre-Built BCC Tools
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Pre-Built BCC Tools">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-explore-available-tools" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 Explore Available Tools
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-execsnoop-trace-process-execution" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 execsnoop - Trace Process Execution
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-opensnoop-trace-file-opens" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.3 opensnoop - Trace File Opens
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34-biotop-top-like-disk-io" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4 biotop - Top-Like Disk I/O
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-tcpconnect-trace-tcp-connections" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5 tcpconnect - Trace TCP Connections
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-write-custom-bcc-scripts" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Write Custom BCC Scripts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Write Custom BCC Scripts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-hello-world-bcc-program" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 Hello World BCC Program
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-count-system-calls" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 Count System Calls
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-trace-function-arguments" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3 Trace Function Arguments
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-bpf-maps-for-data-collection" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. BPF Maps for Data Collection
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. BPF Maps for Data Collection">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51-bpf-map-types" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1 BPF Map Types
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52-use-hash-map-for-aggregation" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.2 Use Hash Map for Aggregation
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-network-packet-tracing" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Network Packet Tracing
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. Network Packet Tracing">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-trace-tcp-packets" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 Trace TCP Packets
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-porting-to-libbpf-embedded" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Porting to libbpf (Embedded)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. Porting to libbpf (Embedded)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-why-libbpf" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.1 Why libbpf?
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-write-libbpf-program" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2 Write libbpf Program
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#8-real-world-use-cases" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. Real-World Use Cases
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Real-World Use Cases">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-detect-unauthorized-file-access" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.1 Detect Unauthorized File Access
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-network-monitoring" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.2 Network Monitoring
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#9-performance-considerations" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. Performance Considerations
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Performance Considerations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#91-overhead-measurement" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.1 Overhead Measurement
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#92-optimization-tips" class="md-nav__link">
    <span class="md-ellipsis">
      
        9.2 Optimization Tips
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#10-troubleshooting" class="md-nav__link">
    <span class="md-ellipsis">
      
        10. Troubleshooting
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10. Troubleshooting">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#101-bpf-verifier-errors" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.1 BPF Verifier Errors
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#102-missing-kernel-symbols" class="md-nav__link">
    <span class="md-ellipsis">
      
        10.2 Missing Kernel Symbols
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#11-key-takeaways" class="md-nav__link">
    <span class="md-ellipsis">
      
        11. Key Takeaways
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#12-verification-checklist" class="md-nav__link">
    <span class="md-ellipsis">
      
        12. Verification Checklist
      
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="lab-24-ebpf-and-bcc-tracing">Lab 24: eBPF and BCC Tracing<a class="headerlink" href="#lab-24-ebpf-and-bcc-tracing" title="Permanent link">&para;</a></h1>
<h2 id="dont-panic">DON'T PANIC<a class="headerlink" href="#dont-panic" title="Permanent link">&para;</a></h2>
<p>The Hitchhiker's Guide to Embedded Linux has this to say about debugging:</p>
<p><em>"Debugging is the art of figuring out why your code doesn't work, as opposed to why you thought it would work. This is similar to the difference between what Deep Thought calculated (42) and what everyone expected (a useful answer). Both are technically correct, but only one is helpful."</em></p>
<h2 id="objectives">Objectives<a class="headerlink" href="#objectives" title="Permanent link">&para;</a></h2>
<p>Master eBPF (extended Berkeley Packet Filter) and BCC (BPF Compiler Collection) for creating custom, low-overhead tracing tools that run safely in the kernel.</p>
<p><strong>What You'll Learn:</strong>
- Understand eBPF architecture and capabilities
- Use BCC tools for system analysis
- Write custom BCC tracing scripts in Python
- Port BCC tools to embedded systems with libbpf
- Trace network packets, disk I/O, and system calls
- Create production-ready eBPF programs</p>
<p><strong>Time Required:</strong> 4-5 hours</p>
<hr />
<h2 id="prerequisites">Prerequisites<a class="headerlink" href="#prerequisites" title="Permanent link">&para;</a></h2>
<p><strong>Hardware:</strong>
- BeaglePlay board
- Development workstation
- 2GB+ RAM</p>
<p><strong>Software:</strong>
- Linux kernel 4.9+ with eBPF support
- BCC tools installed
- Python 3.x
- LLVM/Clang compiler</p>
<hr />
<h2 id="1-introduction-to-ebpf">1. Introduction to eBPF<a class="headerlink" href="#1-introduction-to-ebpf" title="Permanent link">&para;</a></h2>
<h3 id="11-what-is-ebpf">1.1 What is eBPF?<a class="headerlink" href="#11-what-is-ebpf" title="Permanent link">&para;</a></h3>
<p><strong>eBPF</strong> enables running sandboxed programs in the kernel without changing kernel source code or loading kernel modules.</p>
<p><strong>Use cases:</strong>
- Performance monitoring and profiling
- Network packet filtering and manipulation
- Security policy enforcement
- System call filtering (seccomp-bpf)</p>
<p><strong>Advantages:</strong>
- <strong>Safe</strong>: Verified by kernel to prevent crashes
- <strong>Fast</strong>: JIT-compiled to native code
- <strong>No kernel recompilation</strong>: Dynamic loading
- <strong>Low overhead</strong>: Minimal performance impact</p>
<h3 id="12-ebpf-architecture">1.2 eBPF Architecture<a class="headerlink" href="#12-ebpf-architecture" title="Permanent link">&para;</a></h3>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>User Space:
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>  
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>   BCC/libbpf    Python/C program
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>  
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>          syscall(bpf)
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>Kernel Space:
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>  
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>   BPF Verifier  Ensures program safety
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>  
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>  
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>    JIT Compiler  Compile to ARM64 code
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>  
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>  
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>   BPF Program   Runs on events (kprobes, tracepoints, etc.)
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>  
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>  
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>    BPF Maps     Shared data structures
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>  
</code></pre></div>
<h3 id="13-kernel-configuration">1.3 Kernel Configuration<a class="headerlink" href="#13-kernel-configuration" title="Permanent link">&para;</a></h3>
<p><strong>Required configs:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a>CONFIG_BPF=y
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a>CONFIG_BPF_SYSCALL=y
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a>CONFIG_BPF_JIT=y
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>CONFIG_HAVE_EBPF_JIT=y
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a>CONFIG_BPF_EVENTS=y
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a>CONFIG_KPROBES=y
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>CONFIG_UPROBES=y
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>CONFIG_TRACEPOINTS=y
</code></pre></div></p>
<p><strong>Verify:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a>cat<span class="w"> </span>/boot/config-<span class="k">$(</span>uname<span class="w"> </span>-r<span class="k">)</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>CONFIG_BPF
</code></pre></div></p>
<hr />
<h2 id="2-install-bcc">2. Install BCC<a class="headerlink" href="#2-install-bcc" title="Permanent link">&para;</a></h2>
<h3 id="21-bcc-on-workstation">2.1 BCC on Workstation<a class="headerlink" href="#21-bcc-on-workstation" title="Permanent link">&para;</a></h3>
<p><strong>Ubuntu/Debian:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>sudo<span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>bpfcc-tools<span class="w"> </span>python3-bpfcc<span class="w"> </span>libbpfcc-dev<span class="w"> </span>linux-headers-<span class="k">$(</span>uname<span class="w"> </span>-r<span class="k">)</span>
</code></pre></div></p>
<p><strong>Verify:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a>ls<span class="w"> </span>/usr/share/bcc/tools/
</code></pre></div></p>
<h3 id="22-bcc-on-beagleplay-cross-compile">2.2 BCC on BeaglePlay (Cross-Compile)<a class="headerlink" href="#22-bcc-on-beagleplay-cross-compile" title="Permanent link">&para;</a></h3>
<p><strong>Yocto setup:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="c1"># In local.conf</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>IMAGE_INSTALL:append<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">&quot; bcc python3-bcc kernel-dev&quot;</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="c1"># May need to build BCC from source for ARM64</span>
</code></pre></div></p>
<p><strong>Buildroot:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a>make<span class="w"> </span>menuconfig
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="c1"># Target packages  Debugging  bcc</span>
</code></pre></div></p>
<p><strong>The Guide notes:</strong> BCC has heavy dependencies (LLVM, Python). For embedded, consider libbpf (Lab 24.7).</p>
<hr />
<h2 id="3-pre-built-bcc-tools">3. Pre-Built BCC Tools<a class="headerlink" href="#3-pre-built-bcc-tools" title="Permanent link">&para;</a></h2>
<h3 id="31-explore-available-tools">3.1 Explore Available Tools<a class="headerlink" href="#31-explore-available-tools" title="Permanent link">&para;</a></h3>
<p><strong>List tools:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a>ls<span class="w"> </span>/usr/share/bcc/tools/
</code></pre></div></p>
<p><strong>Categories:</strong>
- <strong>File I/O</strong>: <code>opensnoop</code>, <code>statsnoop</code>, <code>filetop</code>
- <strong>Disk I/O</strong>: <code>biotop</code>, <code>biolatency</code>, <code>biosnoop</code>
- <strong>Network</strong>: <code>tcpconnect</code>, <code>tcpaccept</code>, <code>tcptop</code>
- <strong>Process</strong>: <code>execsnoop</code>, <code>exitsnoop</code>, <code>pidstat</code>
- <strong>Performance</strong>: <code>profile</code>, <code>offcputime</code>, <code>funccount</code></p>
<h3 id="32-execsnoop-trace-process-execution">3.2 execsnoop - Trace Process Execution<a class="headerlink" href="#32-execsnoop-trace-process-execution" title="Permanent link">&para;</a></h3>
<p><strong>Monitor all new processes:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a>sudo<span class="w"> </span>/usr/share/bcc/tools/execsnoop
</code></pre></div></p>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>PCOMM            PID    PPID   RET ARGS
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a>bash             567    456      0 /usr/bin/ls -la
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>grep             568    567      0 /usr/bin/grep hello
</code></pre></div></p>
<p><strong>Shows:</strong>
- Parent process (PPID)
- Return code (RET)
- Full command arguments</p>
<p><strong>Use case:</strong> Detect unwanted process spawning.</p>
<h3 id="33-opensnoop-trace-file-opens">3.3 opensnoop - Trace File Opens<a class="headerlink" href="#33-opensnoop-trace-file-opens" title="Permanent link">&para;</a></h3>
<p><strong>Monitor file opens:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>sudo<span class="w"> </span>/usr/share/bcc/tools/opensnoop
</code></pre></div></p>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a>PID    COMM               FD ERR PATH
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a>567    cat                 3   0 /etc/hostname
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>568    vim                 3   0 /home/root/.vimrc
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>569    systemd             4   2 /var/log/messages
</code></pre></div></p>
<p><strong>ERR column:</strong> 0 = success, non-zero = error code.</p>
<p><strong>Use case:</strong> Debug "file not found" errors.</p>
<h3 id="34-biotop-top-like-disk-io">3.4 biotop - Top-Like Disk I/O<a class="headerlink" href="#34-biotop-top-like-disk-io" title="Permanent link">&para;</a></h3>
<p><strong>Monitor disk I/O by process:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a>sudo<span class="w"> </span>/usr/share/bcc/tools/biotop
</code></pre></div></p>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>PID    COMM             D MAJ MIN  DISK       I/O  Kbytes     AVGms
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>567    tar              R 179   0  mmcblk0   1234  123456     12.34
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>568    dd               W 179   0  mmcblk0    567   56789     23.45
</code></pre></div></p>
<p><strong>Columns:</strong>
- <strong>D</strong>: Direction (R=read, W=write)
- <strong>I/O</strong>: Number of I/O operations
- <strong>AVGms</strong>: Average latency</p>
<h3 id="35-tcpconnect-trace-tcp-connections">3.5 tcpconnect - Trace TCP Connections<a class="headerlink" href="#35-tcpconnect-trace-tcp-connections" title="Permanent link">&para;</a></h3>
<p><strong>Monitor outbound TCP connections:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>sudo<span class="w"> </span>/usr/share/bcc/tools/tcpconnect
</code></pre></div></p>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>PID    COMM         IP SADDR            DADDR            DPORT
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>567    curl         4  192.168.0.100    93.184.216.34    80
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>568    ssh          4  192.168.0.100    192.168.0.1      22
</code></pre></div></p>
<p><strong>Use case:</strong> Detect unexpected network connections.</p>
<hr />
<h2 id="4-write-custom-bcc-scripts">4. Write Custom BCC Scripts<a class="headerlink" href="#4-write-custom-bcc-scripts" title="Permanent link">&para;</a></h2>
<h3 id="41-hello-world-bcc-program">4.1 Hello World BCC Program<a class="headerlink" href="#41-hello-world-bcc-program" title="Permanent link">&para;</a></h3>
<p><strong>Create <code>hello_bcc.py</code>:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="ch">#!/usr/bin/env python3</span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">bcc</span><span class="w"> </span><span class="kn">import</span> <span class="n">BPF</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="c1"># BPF program (C code)</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="n">prog</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="s2">int hello(void *ctx) {</span>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="s2">    bpf_trace_printk(&quot;Hello, eBPF!</span><span class="se">\\</span><span class="s2">n&quot;);</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="s2">    return 0;</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="s2">}</span>
<a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a>
<a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="c1"># Load BPF program</span>
<a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="n">b</span> <span class="o">=</span> <span class="n">BPF</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">prog</span><span class="p">)</span>
<a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a>
<a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="c1"># Attach to system call (execve)</span>
<a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="n">b</span><span class="o">.</span><span class="n">attach_kprobe</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s2">&quot;__arm64_sys_execve&quot;</span><span class="p">,</span> <span class="n">fn_name</span><span class="o">=</span><span class="s2">&quot;hello&quot;</span><span class="p">)</span>
<a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a>
<a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="c1"># Print trace messages</span>
<a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracing execve... Hit Ctrl-C to stop.&quot;</span><span class="p">)</span>
<a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a>    <span class="n">b</span><span class="o">.</span><span class="n">trace_print</span><span class="p">()</span>
<a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
<a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a>    <span class="k">pass</span>
</code></pre></div></p>
<p><strong>Run:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>sudo<span class="w"> </span>python3<span class="w"> </span>hello_bcc.py
</code></pre></div></p>
<p><strong>In another terminal, run commands:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>ls
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="nb">echo</span><span class="w"> </span><span class="nb">test</span>
</code></pre></div></p>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>Tracing execve... Hit Ctrl-C to stop.
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>            bash-567   [000] d... 123.456789: hello: Hello, eBPF!
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>            bash-568   [001] d... 123.567890: hello: Hello, eBPF!
</code></pre></div></p>
<h3 id="42-count-system-calls">4.2 Count System Calls<a class="headerlink" href="#42-count-system-calls" title="Permanent link">&para;</a></h3>
<p><strong>Create <code>syscall_count.py</code>:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="ch">#!/usr/bin/env python3</span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">bcc</span><span class="w"> </span><span class="kn">import</span> <span class="n">BPF</span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">sleep</span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="n">prog</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="s2">#include &lt;uapi/linux/ptrace.h&gt;</span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a><span class="s2">BPF_HASH(syscall_count, u64);</span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a><span class="s2">int count_syscalls(struct pt_regs *ctx) {</span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a><span class="s2">    u64 syscall_nr = ctx-&gt;regs[8];  // ARM64: x8 register holds syscall number</span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a><span class="s2">    u64 *count = syscall_count.lookup(&amp;syscall_nr);</span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="s2">    if (count) {</span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a><span class="s2">        (*count)++;</span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a><span class="s2">    } else {</span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a><span class="s2">        u64 initial = 1;</span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a><span class="s2">        syscall_count.update(&amp;syscall_nr, &amp;initial);</span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a><span class="s2">    }</span>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a><span class="s2">    return 0;</span>
<a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a><span class="s2">}</span>
<a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a>
<a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a><span class="n">b</span> <span class="o">=</span> <span class="n">BPF</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">prog</span><span class="p">)</span>
<a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a><span class="n">b</span><span class="o">.</span><span class="n">attach_kprobe</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s2">&quot;__arm64_sys_call&quot;</span><span class="p">,</span> <span class="n">fn_name</span><span class="o">=</span><span class="s2">&quot;count_syscalls&quot;</span><span class="p">)</span>
<a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a>
<a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Counting syscalls for 10 seconds...&quot;</span><span class="p">)</span>
<a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a><span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>
<a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a><span class="c1"># Print syscall counts</span>
<a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Top 10 syscalls:&quot;</span><span class="p">)</span>
<a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a><span class="n">counts</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="s2">&quot;syscall_count&quot;</span><span class="p">]</span>
<a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a><span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">counts</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)[:</span><span class="mi">10</span><span class="p">]:</span>
<a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Syscall </span><span class="si">{</span><span class="n">k</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">3d</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">value</span><span class="si">:</span><span class="s2">6d</span><span class="si">}</span><span class="s2"> calls&quot;</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>Top 10 syscalls:
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#__codelineno-21-2"></a>Syscall  63:  12345 calls  # read()
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#__codelineno-21-3"></a>Syscall  64:   9876 calls  # write()
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#__codelineno-21-4"></a>Syscall  57:   5432 calls  # close()
</code></pre></div></p>
<h3 id="43-trace-function-arguments">4.3 Trace Function Arguments<a class="headerlink" href="#43-trace-function-arguments" title="Permanent link">&para;</a></h3>
<p><strong>Create <code>trace_open.py</code>:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="ch">#!/usr/bin/env python3</span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">bcc</span><span class="w"> </span><span class="kn">import</span> <span class="n">BPF</span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="n">prog</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="s2">#include &lt;uapi/linux/ptrace.h&gt;</span>
<a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a>
<a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="s2">int trace_open(struct pt_regs *ctx, const char *filename) {</span>
<a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="s2">    char fn[256];</span>
<a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="s2">    bpf_probe_read_user(&amp;fn, sizeof(fn), (void *)filename);</span>
<a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="s2">    bpf_trace_printk(&quot;open(</span><span class="si">%s</span><span class="s2">)</span><span class="se">\\</span><span class="s2">n&quot;, fn);</span>
<a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="s2">    return 0;</span>
<a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="s2">}</span>
<a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a>
<a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="n">b</span> <span class="o">=</span> <span class="n">BPF</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">prog</span><span class="p">)</span>
<a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="n">b</span><span class="o">.</span><span class="n">attach_kprobe</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s2">&quot;do_sys_open&quot;</span><span class="p">,</span> <span class="n">fn_name</span><span class="o">=</span><span class="s2">&quot;trace_open&quot;</span><span class="p">)</span>
<a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a>
<a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracing open() syscalls... Ctrl-C to stop.&quot;</span><span class="p">)</span>
<a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a>    <span class="n">b</span><span class="o">.</span><span class="n">trace_print</span><span class="p">()</span>
<a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
<a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a>    <span class="k">pass</span>
</code></pre></div></p>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>cat-567   [000] d... 123.456789: trace_open: open(/etc/hostname)
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>vim-568   [001] d... 123.567890: trace_open: open(/home/root/.vimrc)
</code></pre></div></p>
<hr />
<h2 id="5-bpf-maps-for-data-collection">5. BPF Maps for Data Collection<a class="headerlink" href="#5-bpf-maps-for-data-collection" title="Permanent link">&para;</a></h2>
<h3 id="51-bpf-map-types">5.1 BPF Map Types<a class="headerlink" href="#51-bpf-map-types" title="Permanent link">&para;</a></h3>
<p><strong>Common map types:</strong>
- <strong>BPF_HASH</strong>: Hash table
- <strong>BPF_ARRAY</strong>: Fixed-size array
- <strong>BPF_PERF_ARRAY</strong>: Performance event array
- <strong>BPF_RINGBUF</strong>: Ring buffer (kernel 5.8+)</p>
<h3 id="52-use-hash-map-for-aggregation">5.2 Use Hash Map for Aggregation<a class="headerlink" href="#52-use-hash-map-for-aggregation" title="Permanent link">&para;</a></h3>
<p><strong>Create <code>io_latency.py</code>:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="ch">#!/usr/bin/env python3</span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">bcc</span><span class="w"> </span><span class="kn">import</span> <span class="n">BPF</span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="kn">import</span> <span class="n">sleep</span>
<a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a>
<a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a><span class="n">prog</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a><span class="s2">#include &lt;uapi/linux/ptrace.h&gt;</span>
<a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a><span class="s2">#include &lt;linux/blkdev.h&gt;</span>
<a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>
<a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a><span class="s2">BPF_HASH(start, struct request *);</span>
<a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a><span class="s2">BPF_HISTOGRAM(latency_us);</span>
<a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>
<a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a><span class="s2">int trace_req_start(struct pt_regs *ctx, struct request *req) {</span>
<a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="s2">    u64 ts = bpf_ktime_get_ns();</span>
<a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a><span class="s2">    start.update(&amp;req, &amp;ts);</span>
<a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a><span class="s2">    return 0;</span>
<a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a><span class="s2">}</span>
<a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>
<a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a><span class="s2">int trace_req_done(struct pt_regs *ctx, struct request *req) {</span>
<a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a><span class="s2">    u64 *tsp = start.lookup(&amp;req);</span>
<a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a><span class="s2">    if (tsp) {</span>
<a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a><span class="s2">        u64 delta = bpf_ktime_get_ns() - *tsp;</span>
<a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="s2">        latency_us.increment(bpf_log2l(delta / 1000));</span>
<a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a><span class="s2">        start.delete(&amp;req);</span>
<a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a><span class="s2">    }</span>
<a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a><span class="s2">    return 0;</span>
<a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a><span class="s2">}</span>
<a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a>
<a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a><span class="n">b</span> <span class="o">=</span> <span class="n">BPF</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">prog</span><span class="p">)</span>
<a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a><span class="n">b</span><span class="o">.</span><span class="n">attach_kprobe</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s2">&quot;blk_account_io_start&quot;</span><span class="p">,</span> <span class="n">fn_name</span><span class="o">=</span><span class="s2">&quot;trace_req_start&quot;</span><span class="p">)</span>
<a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a><span class="n">b</span><span class="o">.</span><span class="n">attach_kprobe</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s2">&quot;blk_account_io_done&quot;</span><span class="p">,</span> <span class="n">fn_name</span><span class="o">=</span><span class="s2">&quot;trace_req_done&quot;</span><span class="p">)</span>
<a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a>
<a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracing block I/O latency... Hit Ctrl-C to stop.&quot;</span><span class="p">)</span>
<a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a>    <span class="n">sleep</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
<a id="__codelineno-24-36" name="__codelineno-24-36" href="#__codelineno-24-36"></a><span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
<a id="__codelineno-24-37" name="__codelineno-24-37" href="#__codelineno-24-37"></a>    <span class="k">pass</span>
<a id="__codelineno-24-38" name="__codelineno-24-38" href="#__codelineno-24-38"></a>
<a id="__codelineno-24-39" name="__codelineno-24-39" href="#__codelineno-24-39"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">I/O Latency Distribution (microseconds):&quot;</span><span class="p">)</span>
<a id="__codelineno-24-40" name="__codelineno-24-40" href="#__codelineno-24-40"></a><span class="n">b</span><span class="p">[</span><span class="s2">&quot;latency_us&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">print_log2_hist</span><span class="p">(</span><span class="s2">&quot;latency (us)&quot;</span><span class="p">)</span>
</code></pre></div></p>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a>I/O Latency Distribution (microseconds):
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a>     latency (us)    : count     distribution
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a>         0 -&gt; 1      : 0        |                                        |
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a>         2 -&gt; 3      : 5        |*                                       |
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a>         4 -&gt; 7      : 123      |***********                             |
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a>         8 -&gt; 15     : 456      |******************************************|
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a>        16 -&gt; 31     : 234      |*********************                   |
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a>        32 -&gt; 63     : 89       |********                                |
</code></pre></div></p>
<hr />
<h2 id="6-network-packet-tracing">6. Network Packet Tracing<a class="headerlink" href="#6-network-packet-tracing" title="Permanent link">&para;</a></h2>
<h3 id="61-trace-tcp-packets">6.1 Trace TCP Packets<a class="headerlink" href="#61-trace-tcp-packets" title="Permanent link">&para;</a></h3>
<p><strong>Create <code>tcp_trace.py</code>:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="ch">#!/usr/bin/env python3</span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">bcc</span><span class="w"> </span><span class="kn">import</span> <span class="n">BPF</span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="n">prog</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-26-5" name="__codelineno-26-5" href="#__codelineno-26-5"></a><span class="s2">#include &lt;uapi/linux/ptrace.h&gt;</span>
<a id="__codelineno-26-6" name="__codelineno-26-6" href="#__codelineno-26-6"></a><span class="s2">#include &lt;net/sock.h&gt;</span>
<a id="__codelineno-26-7" name="__codelineno-26-7" href="#__codelineno-26-7"></a><span class="s2">#include &lt;bcc/proto.h&gt;</span>
<a id="__codelineno-26-8" name="__codelineno-26-8" href="#__codelineno-26-8"></a>
<a id="__codelineno-26-9" name="__codelineno-26-9" href="#__codelineno-26-9"></a><span class="s2">int trace_tcp_sendmsg(struct pt_regs *ctx, struct sock *sk) {</span>
<a id="__codelineno-26-10" name="__codelineno-26-10" href="#__codelineno-26-10"></a><span class="s2">    u32 saddr = sk-&gt;__sk_common.skc_rcv_saddr;</span>
<a id="__codelineno-26-11" name="__codelineno-26-11" href="#__codelineno-26-11"></a><span class="s2">    u32 daddr = sk-&gt;__sk_common.skc_daddr;</span>
<a id="__codelineno-26-12" name="__codelineno-26-12" href="#__codelineno-26-12"></a><span class="s2">    u16 sport = sk-&gt;__sk_common.skc_num;</span>
<a id="__codelineno-26-13" name="__codelineno-26-13" href="#__codelineno-26-13"></a><span class="s2">    u16 dport = sk-&gt;__sk_common.skc_dport;</span>
<a id="__codelineno-26-14" name="__codelineno-26-14" href="#__codelineno-26-14"></a>
<a id="__codelineno-26-15" name="__codelineno-26-15" href="#__codelineno-26-15"></a><span class="s2">    bpf_trace_printk(&quot;TCP %pI4:</span><span class="si">%d</span><span class="s2"> -&gt; %pI4:</span><span class="si">%d</span><span class="se">\\</span><span class="s2">n&quot;, &amp;saddr, sport, &amp;daddr, ntohs(dport));</span>
<a id="__codelineno-26-16" name="__codelineno-26-16" href="#__codelineno-26-16"></a><span class="s2">    return 0;</span>
<a id="__codelineno-26-17" name="__codelineno-26-17" href="#__codelineno-26-17"></a><span class="s2">}</span>
<a id="__codelineno-26-18" name="__codelineno-26-18" href="#__codelineno-26-18"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-26-19" name="__codelineno-26-19" href="#__codelineno-26-19"></a>
<a id="__codelineno-26-20" name="__codelineno-26-20" href="#__codelineno-26-20"></a><span class="n">b</span> <span class="o">=</span> <span class="n">BPF</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">prog</span><span class="p">)</span>
<a id="__codelineno-26-21" name="__codelineno-26-21" href="#__codelineno-26-21"></a><span class="n">b</span><span class="o">.</span><span class="n">attach_kprobe</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s2">&quot;tcp_sendmsg&quot;</span><span class="p">,</span> <span class="n">fn_name</span><span class="o">=</span><span class="s2">&quot;trace_tcp_sendmsg&quot;</span><span class="p">)</span>
<a id="__codelineno-26-22" name="__codelineno-26-22" href="#__codelineno-26-22"></a>
<a id="__codelineno-26-23" name="__codelineno-26-23" href="#__codelineno-26-23"></a><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tracing TCP sends... Ctrl-C to stop.&quot;</span><span class="p">)</span>
<a id="__codelineno-26-24" name="__codelineno-26-24" href="#__codelineno-26-24"></a><span class="k">try</span><span class="p">:</span>
<a id="__codelineno-26-25" name="__codelineno-26-25" href="#__codelineno-26-25"></a>    <span class="n">b</span><span class="o">.</span><span class="n">trace_print</span><span class="p">()</span>
<a id="__codelineno-26-26" name="__codelineno-26-26" href="#__codelineno-26-26"></a><span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
<a id="__codelineno-26-27" name="__codelineno-26-27" href="#__codelineno-26-27"></a>    <span class="k">pass</span>
</code></pre></div></p>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a>curl-567   [000] d... 123.456789: trace_tcp_sendmsg: TCP 192.168.0.100:54321 -&gt; 93.184.216.34:80
</code></pre></div></p>
<hr />
<h2 id="7-porting-to-libbpf-embedded">7. Porting to libbpf (Embedded)<a class="headerlink" href="#7-porting-to-libbpf-embedded" title="Permanent link">&para;</a></h2>
<h3 id="71-why-libbpf">7.1 Why libbpf?<a class="headerlink" href="#71-why-libbpf" title="Permanent link">&para;</a></h3>
<p><strong>BCC challenges on embedded:</strong>
- Large dependencies (Python, LLVM)
- Compiles BPF at runtime (slow, high memory)</p>
<p><strong>libbpf advantages:</strong>
- Minimal dependencies (single C library)
- Pre-compiled BPF bytecode
- CO-RE (Compile Once, Run Everywhere)</p>
<h3 id="72-write-libbpf-program">7.2 Write libbpf Program<a class="headerlink" href="#72-write-libbpf-program" title="Permanent link">&para;</a></h3>
<p><strong>Create <code>hello_libbpf.bpf.c</code>:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;linux/bpf.h&gt;</span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;bpf/bpf_helpers.h&gt;</span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;kprobe/__arm64_sys_execve&quot;</span><span class="p">)</span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="kt">int</span><span class="w"> </span><span class="n">hello_bpf</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">msg</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Hello from libbpf!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">    </span><span class="n">bpf_trace_printk</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a><span class="p">}</span>
<a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>
<a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a><span class="kt">char</span><span class="w"> </span><span class="n">LICENSE</span><span class="p">[]</span><span class="w"> </span><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;license&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;GPL&quot;</span><span class="p">;</span>
</code></pre></div></p>
<p><strong>Compile to BPF bytecode:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>clang<span class="w"> </span>-O2<span class="w"> </span>-target<span class="w"> </span>bpf<span class="w"> </span>-c<span class="w"> </span>hello_libbpf.bpf.c<span class="w"> </span>-o<span class="w"> </span>hello_libbpf.bpf.o
</code></pre></div></p>
<p><strong>Loader program <code>hello_libbpf.c</code>:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;bpf/libbpf.h&gt;</span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;bpf/bpf.h&gt;</span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_object</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="p">;</span>
<a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_program</span><span class="w"> </span><span class="o">*</span><span class="n">prog</span><span class="p">;</span>
<a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">bpf_link</span><span class="w"> </span><span class="o">*</span><span class="n">link</span><span class="p">;</span>
<a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a>
<a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="w">    </span><span class="c1">// Load BPF object</span>
<a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="w">    </span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_object__open_file</span><span class="p">(</span><span class="s">&quot;hello_libbpf.bpf.o&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a>
<a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a><span class="w">    </span><span class="n">bpf_object__load</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a>
<a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a><span class="w">    </span><span class="c1">// Attach to kprobe</span>
<a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a><span class="w">    </span><span class="n">prog</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_object__find_program_by_name</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;hello_bpf&quot;</span><span class="p">);</span>
<a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a><span class="w">    </span><span class="n">link</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bpf_program__attach</span><span class="p">(</span><span class="n">prog</span><span class="p">);</span>
<a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a>
<a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a><span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Attached. Check /sys/kernel/debug/tracing/trace_pipe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a><span class="w">    </span><span class="n">getchar</span><span class="p">();</span><span class="w">  </span><span class="c1">// Wait for Ctrl-C</span>
<a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a>
<a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a><span class="w">    </span><span class="n">bpf_link__destroy</span><span class="p">(</span><span class="n">link</span><span class="p">);</span>
<a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a><span class="w">    </span><span class="n">bpf_object__close</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<a id="__codelineno-30-25" name="__codelineno-30-25" href="#__codelineno-30-25"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-30-26" name="__codelineno-30-26" href="#__codelineno-30-26"></a><span class="p">}</span>
</code></pre></div></p>
<p><strong>Compile loader:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>gcc<span class="w"> </span>-o<span class="w"> </span>hello_libbpf<span class="w"> </span>hello_libbpf.c<span class="w"> </span>-lbpf
</code></pre></div></p>
<p><strong>Run:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>sudo<span class="w"> </span>./hello_libbpf<span class="w"> </span><span class="p">&amp;</span>
<a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>sudo<span class="w"> </span>cat<span class="w"> </span>/sys/kernel/debug/tracing/trace_pipe
</code></pre></div></p>
<hr />
<h2 id="8-real-world-use-cases">8. Real-World Use Cases<a class="headerlink" href="#8-real-world-use-cases" title="Permanent link">&para;</a></h2>
<h3 id="81-detect-unauthorized-file-access">8.1 Detect Unauthorized File Access<a class="headerlink" href="#81-detect-unauthorized-file-access" title="Permanent link">&para;</a></h3>
<p><strong>Monitor sensitive files:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">bcc</span><span class="w"> </span><span class="kn">import</span> <span class="n">BPF</span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="n">prog</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-33-4" name="__codelineno-33-4" href="#__codelineno-33-4"></a><span class="s2">int trace_open(struct pt_regs *ctx, const char *filename) {</span>
<a id="__codelineno-33-5" name="__codelineno-33-5" href="#__codelineno-33-5"></a><span class="s2">    char fn[256];</span>
<a id="__codelineno-33-6" name="__codelineno-33-6" href="#__codelineno-33-6"></a><span class="s2">    bpf_probe_read_user(&amp;fn, sizeof(fn), (void *)filename);</span>
<a id="__codelineno-33-7" name="__codelineno-33-7" href="#__codelineno-33-7"></a>
<a id="__codelineno-33-8" name="__codelineno-33-8" href="#__codelineno-33-8"></a><span class="s2">    // Check for /etc/shadow access</span>
<a id="__codelineno-33-9" name="__codelineno-33-9" href="#__codelineno-33-9"></a><span class="s2">    char target[] = &quot;/etc/shadow&quot;;</span>
<a id="__codelineno-33-10" name="__codelineno-33-10" href="#__codelineno-33-10"></a><span class="s2">    for (int i = 0; i &lt; sizeof(target); i++) {</span>
<a id="__codelineno-33-11" name="__codelineno-33-11" href="#__codelineno-33-11"></a><span class="s2">        if (fn[i] != target[i]) return 0;</span>
<a id="__codelineno-33-12" name="__codelineno-33-12" href="#__codelineno-33-12"></a><span class="s2">    }</span>
<a id="__codelineno-33-13" name="__codelineno-33-13" href="#__codelineno-33-13"></a>
<a id="__codelineno-33-14" name="__codelineno-33-14" href="#__codelineno-33-14"></a><span class="s2">    bpf_trace_printk(&quot;ALERT: /etc/shadow accessed!</span><span class="se">\\</span><span class="s2">n&quot;);</span>
<a id="__codelineno-33-15" name="__codelineno-33-15" href="#__codelineno-33-15"></a><span class="s2">    return 0;</span>
<a id="__codelineno-33-16" name="__codelineno-33-16" href="#__codelineno-33-16"></a><span class="s2">}</span>
<a id="__codelineno-33-17" name="__codelineno-33-17" href="#__codelineno-33-17"></a><span class="s2">&quot;&quot;&quot;</span>
<a id="__codelineno-33-18" name="__codelineno-33-18" href="#__codelineno-33-18"></a>
<a id="__codelineno-33-19" name="__codelineno-33-19" href="#__codelineno-33-19"></a><span class="n">b</span> <span class="o">=</span> <span class="n">BPF</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">prog</span><span class="p">)</span>
<a id="__codelineno-33-20" name="__codelineno-33-20" href="#__codelineno-33-20"></a><span class="n">b</span><span class="o">.</span><span class="n">attach_kprobe</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="s2">&quot;do_sys_open&quot;</span><span class="p">,</span> <span class="n">fn_name</span><span class="o">=</span><span class="s2">&quot;trace_open&quot;</span><span class="p">)</span>
<a id="__codelineno-33-21" name="__codelineno-33-21" href="#__codelineno-33-21"></a><span class="n">b</span><span class="o">.</span><span class="n">trace_print</span><span class="p">()</span>
</code></pre></div></p>
<h3 id="82-network-monitoring">8.2 Network Monitoring<a class="headerlink" href="#82-network-monitoring" title="Permanent link">&para;</a></h3>
<p><strong>Track bandwidth per process:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="c1"># Use tcptop BCC tool</span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">bcc</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">tcptop</span>
</code></pre></div></p>
<p><strong>Output:</strong>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a>PID    COMM         LADDR                 RADDR                  RX_KB  TX_KB
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a>567    curl         192.168.0.100:54321   93.184.216.34:80         128     12
<a id="__codelineno-35-3" name="__codelineno-35-3" href="#__codelineno-35-3"></a>568    sshd         192.168.0.100:22      192.168.0.1:12345        456    234
</code></pre></div></p>
<hr />
<h2 id="9-performance-considerations">9. Performance Considerations<a class="headerlink" href="#9-performance-considerations" title="Permanent link">&para;</a></h2>
<h3 id="91-overhead-measurement">9.1 Overhead Measurement<a class="headerlink" href="#91-overhead-measurement" title="Permanent link">&para;</a></h3>
<p><strong>eBPF has minimal overhead (~1-5%):</strong></p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="c1"># Baseline</span>
<a id="__codelineno-36-2" name="__codelineno-36-2" href="#__codelineno-36-2"></a><span class="nb">time</span><span class="w"> </span>./benchmark
<a id="__codelineno-36-3" name="__codelineno-36-3" href="#__codelineno-36-3"></a>
<a id="__codelineno-36-4" name="__codelineno-36-4" href="#__codelineno-36-4"></a><span class="c1"># With eBPF tracing</span>
<a id="__codelineno-36-5" name="__codelineno-36-5" href="#__codelineno-36-5"></a>sudo<span class="w"> </span>python3<span class="w"> </span>trace_open.py<span class="w"> </span><span class="p">&amp;</span>
<a id="__codelineno-36-6" name="__codelineno-36-6" href="#__codelineno-36-6"></a><span class="nb">time</span><span class="w"> </span>./benchmark
</code></pre></div>
<p><strong>Compare execution times.</strong></p>
<h3 id="92-optimization-tips">9.2 Optimization Tips<a class="headerlink" href="#92-optimization-tips" title="Permanent link">&para;</a></h3>
<ul>
<li>Use <strong>maps</strong> instead of <code>bpf_trace_printk()</code> for production</li>
<li><strong>Filter in kernel</strong> to reduce data transfer</li>
<li>Use <strong>tail calls</strong> for complex logic</li>
<li>Minimize <strong>map lookups</strong></li>
</ul>
<hr />
<h2 id="10-troubleshooting">10. Troubleshooting<a class="headerlink" href="#10-troubleshooting" title="Permanent link">&para;</a></h2>
<h3 id="101-bpf-verifier-errors">10.1 BPF Verifier Errors<a class="headerlink" href="#101-bpf-verifier-errors" title="Permanent link">&para;</a></h3>
<p><strong>Error:</strong> "back-edge in program"
- <strong>Cause</strong>: Loop detected
- <strong>Fix</strong>: Unroll loops or use bounded iteration</p>
<p><strong>Error:</strong> "invalid access to map value"
- <strong>Cause</strong>: Unvalidated pointer
- <strong>Fix</strong>: Check pointer before dereferencing</p>
<h3 id="102-missing-kernel-symbols">10.2 Missing Kernel Symbols<a class="headerlink" href="#102-missing-kernel-symbols" title="Permanent link">&para;</a></h3>
<p><strong>Error:</strong> "could not open kprobe event"
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="c1"># Check available kprobes</span>
<a id="__codelineno-37-2" name="__codelineno-37-2" href="#__codelineno-37-2"></a>cat<span class="w"> </span>/sys/kernel/debug/tracing/available_filter_functions<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>do_sys_open
</code></pre></div></p>
<hr />
<h2 id="11-key-takeaways">11. Key Takeaways<a class="headerlink" href="#11-key-takeaways" title="Permanent link">&para;</a></h2>
<p><strong>Accomplished:</strong>
1.  Understood eBPF architecture
2.  Used pre-built BCC tools
3.  Wrote custom BCC Python scripts
4.  Used BPF maps for data collection
5.  Ported to libbpf for embedded
6.  Traced network and file I/O</p>
<p><strong>Essential Tools:</strong>
- <code>execsnoop</code>: Monitor process execution
- <code>opensnoop</code>: Trace file opens
- <code>tcpconnect</code>: Track TCP connections
- <code>biotop</code>: Disk I/O monitoring</p>
<p><strong>Next Steps:</strong>
- <strong>Lab 25</strong>: Kernel debugging (KGDB, OOPS)
- <strong>Lab 26</strong>: Crash dump analysis</p>
<hr />
<h2 id="12-verification-checklist">12. Verification Checklist<a class="headerlink" href="#12-verification-checklist" title="Permanent link">&para;</a></h2>
<ul>
<li>[ ] Can run BCC pre-built tools</li>
<li>[ ] Can write custom BCC scripts</li>
<li>[ ] Understand BPF maps</li>
<li>[ ] Can trace kernel and userspace events</li>
<li>[ ] Know when to use BCC vs libbpf</li>
<li>[ ] Can debug BPF verifier errors</li>
</ul>
<hr />
<p><strong>End of Lab 24</strong></p>
<p><em>The Guide rates this lab: </em><em>Mostly Harmless</em><em> </em></p>
<p>eBPF is revolutionizing Linux observability and security. It enables powerful, production-safe tracing without kernel modifications, making it ideal for debugging complex systems and enforcing security policies.</p>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="January 30, 2026 15:44:01 UTC">January 30, 2026</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="January 30, 2026 15:44:01 UTC">January 30, 2026</span>
  </span>

    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2025 Jofralso. Licensed under MIT.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/Jofralso" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
    <a href="https://buymeacoffee.com/jofralso" target="_blank" rel="noopener" title="Buy Me A Coffee" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M152-16c-13.3 0-24 10.7-24 24 0 38.9 23.4 59.4 39.1 73.1l1.1 1C184.5 96.4 192 103.9 192 120c0 13.3 10.7 24 24 24s24-10.7 24-24c0-38.9-23.4-59.4-39.1-73.1l-1.1-1C183.5 31.7 176 24.1 176 8c0-13.3-10.7-24-24-24M96 192c-17.7 0-32 14.3-32 32v192c0 53 43 96 96 96h192c41.8 0 77.4-26.7 90.5-64h5.5c70.7 0 128-57.3 128-128s-57.3-128-128-128zm352 192V256c35.3 0 64 28.7 64 64s-28.7 64-64 64M288 8c0-13.3-10.7-24-24-24S240-5.3 240 8c0 38.9 23.4 59.4 39.1 73.1l1.1 1C296.5 96.4 304 103.9 304 120c0 13.3 10.7 24 24 24s24-10.7 24-24c0-38.9-23.4-59.4-39.1-73.1l-1.1-1C295.5 31.7 288 24.1 288 8"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>